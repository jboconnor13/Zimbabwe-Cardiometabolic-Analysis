---
title: "16 Microbiome Analysis"
author: "J. O'Connor"
date: "2025-09-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document competes the analysis comparing microbiome variables (alpha diversity, genera abundance, and beta diversity) to metabolic outcomes.

### Function Sourcing

First the functions are all sourced
```{r Functions, message=FALSE, warning=FALSE}
#To access the functions directory why must direct to the parent directory
setwd("../..")

#A list of the function files is pulled
function_files <- list.files(paste0(getwd(),"/Functions"), pattern = "\\.R$", full.names = TRUE)
#Those functions are then sourced
lapply(function_files, source)
```


### Data Loading

We load all the data of interest

```{r data_load, echo=FALSE}
#All Metadata objects have been stored in one location
metadata_objects <- readRDS("~/Zimbabwe-Cardiometabolic-Analysis/Data/R_Data/metadata_objects.RDS")

#Previusly Determined confounders are loaded
conf_vars <- readRDS("~/Zimbabwe-Cardiometabolic-Analysis/Data/R_Data/conf_vars.RDS")

#Confounders
  #conf_vars_all: All confounders in one vector
  #conf_vars_HDL: Confounders of HDL
  #conf_vars_LDL: Confounders of LDL
  #conf_vars_Trig: Confounders of Trig
  #conf_vars_Glucose: Confounders of Glucose
  conf_vars_all <- conf_vars$conf_vars_all
  conf_vars_HDL <- conf_vars$conf_vars_HDL
  conf_vars_LDL <- conf_vars$conf_vars_LDL
  conf_vars_Trig <- conf_vars$conf_vars_Trig
  conf_vars_Glucose <- conf_vars$conf_vars_Glucose
  

#16S Objects
mic_16S_objects <- readRDS("~/Zimbabwe-Cardiometabolic-Analysis/Data/R_Data/mic_16S_objects.RDS")
  #base: all processed metadata
  #base_with_16S: metadata file with 16S results
  #fecal.gen.names: original genus names
  #RA_plot_16S: data frame with relative abundances for barplot
  #fecal.tax.plot.data: 16S phyloseq object 
  #fecal.wu.biplot:Weighted Unifrac Biplot Objects
  #fecal.wu.matrix: Weighted uniFrac Matrix
  base <- mic_16S_objects$base
  base_with_16S <- mic_16S_objects$base_with_16S
  fecal.gen.names <- mic_16S_objects$fecal.gen.names
  RA_plot_16S <- mic_16S_objects$RA_plot_16S
  fecal.tax.plot.data <- mic_16S_objects$fecal.tax.plot.data
  fecal.wu.biplot <- mic_16S_objects$fecal.wu.biplot
  fecal.wu.matrix <- mic_16S_objects$fecal.wu.matrix
```


### Alpha Diversity Measures

#### Cross Sectional Differences
```{r}
#Cardioetabolic outcome variables are defined

#HDL: plasma high-density lipoprotein cholesterol (HDL-C)
#LDL: plasma low-density lipoprotein cholesterol (HDL-C)
#Trig: plasma triglycerides
#Glucose: Plasma glucose

met_vars <- c("HDL",
              "LDL",
              "Trig",
              "Glucose")

#Inflammatory Measures are defined

#IL6: plasma interleukin-6 
#CRP: plasma C-reactive protein(mg/l)

div_vars <- c("Shannon_Diversity",
              "Faith_Diversity")

#A dislay week helps for the plots (add a weeks label
base$DisplayWeek <- paste0(base$Week, " Weeks")
#The variables are generated by transformaing the data
#met_lmer data is created from the base metadata file
met_lmer_data <- base

## Cross Sectional Statistics

# Stats will be generated across groups (i.e. Cohort) using the gp_stat_sum function

# Statistics are performed on cohorts at different time points

div_stats_co <- gp_stat_sum(data=met_lmer_data,            #Data set specified
                            sub_vars="DisplayWeek",      #Subset variable for stratification is selected
                            dep_vars=div_vars,    #Dependent variables are the div_vars previously defined
                            gp_var="Cohort",      #Group variable is cohort
                            normality= FALSE,     #Data has not been normalized so we are doing nonparametric tests
                            adj="bonferroni"      #p-value adjustment method is Bonferroni
                            )  


```


#### Boxplots
```{r}
# First I use them same color scheme as described in Zim1 
cohortColors <- palette(brewer.pal(n = 5, name = "BrBG"))
cohortColors <- palette(brewer.pal(n = 5, name = "BrBG")) #Repeated to solidify? 
visitColors <- palette(brewer.pal(n = 5, name = "PiYG")) 
visitColors <- palette(brewer.pal(n = 5, name = "PiYG")) #repeat to solidify

alpha_div_data_long <- pivot_longer(data=met_lmer_data,
                                    cols = c("Faith_Diversity","Shannon_Diversity"),
                                    names_to ="Measure",
                                    values_to = "Diversity")

alpha_boxplot <- ggplot(data = alpha_div_data_long,
                      mapping = aes(x = Cohort, y = Diveristy, fill=Cohort)) +
                      geom_boxplot(aes(x = Cohort, y = Diversity, fill=Cohort), 
                                   outliers = FALSE) +
                      geom_jitter(aes(x = Cohort, y = Diversity, fill=Cohort)) +
                      scale_fill_manual(values=c(cohortColors[1],
                                                 cohortColors[3],
                                                 cohortColors[5],
                                                 cohortColors[1],
                                                 cohortColors[3],
                                                 cohortColors[5]))+
                      labs(y="Alpha Diversity Measure", tag="A")+
                      theme_classic() +
                      theme(legend.position = "none",
                            legend.title = element_text(size = 20),
                            legend.text = element_text(size = 20),
                            axis.text.x = element_text(size = 15, hjust=1, angle=45),
                            axis.title.y = element_text(size = 20),
                            axis.title.x = element_blank(),
                            axis.text.y = element_text(size = 15),
                            strip.text.x = element_text(size=15),
                            strip.text.y = element_text(size=15),
                            plot.tag = element_text(size=25),
                            ggh4x.facet.nestline = element_blank(),
                            strip.background.x = element_rect(color="black", fill="gray", linetype="solid"),
                            strip.background.y = element_rect(color="black", fill="gray", linetype="solid")) +
                      facet_nested(cols=vars(DisplayWeek), 
                                   rows=vars(Measure),
                                  scales="free_y") +
                      stat_pvalue_manual(div_stats_co,
                                        label = "p.signif",
                                        hide.ns = TRUE,
                                        y.position=c(8,8,8,125),
                                        step.increase = 0.1,
                                        step.group.by = c("DisplayWeek")
                                        ) 
```

#### Longitudinal Changes
```{r}


## Longitduinal Statistics

# Stats will be generated for longitudinal changes using the long_stat_sum function



div_stats_long <- long_stat_sum(data=met_lmer_data,                   #Data set specified
                                sub_vars="Cohort",           #Subset variable for stratification is selected#
                                tm_var="DisplayWeek",               #The time variable is elected
                                dep_vars=div_vars,           #Dependent variables are the div_vars previously defined 
                                rand_var="PID",              #Random variable (patient ID) is selected
                                normality=FALSE,             #Data has not been normalized so we are doing nonparametric tests
                                adj="bonferroni",            #p-value adjustment method is Bonferroni
                                pw="separate")  #pairwise comparisons are a wilcoxon


#Manual correction because it does so by group
div_stats_long$padj[which(div_stats_long$Cohort=="Naïve")] <- p.adjust(div_stats_long$`p-value`[which(div_stats_long$Cohort=="Naïve")], method="fdr")
div_stats_long$padj[which(div_stats_long$Cohort=="Exp")] <- p.adjust(div_stats_long$`p-value`[which(div_stats_long$Cohort=="Exp")], method="fdr")
div_stats_long$padj[which(div_stats_long$Cohort=="HC")] <- p.adjust(div_stats_long$`p-value`[which(div_stats_long$Cohort=="Exp")], method="fdr") 
div_stats_long$p.signif <- add_asterisks(div_stats_long$padj)   

#We pull out the variables that change in the ART naive group
delta_div_vars <- div_stats_long$Measure[which(div_stats_long$Cohort=="Naïve" & div_stats_long$padj<0.05)]
saveRDS(delta_div_vars, file = "../../Data/R_Data/delta_div_vars.RDS")

#We specify the factors for the weeks and cohort to coicide with the plot
div_stats_long$group1 <- factor(div_stats_long$group1, levels=c("0 Weeks", "24 Weeks"), ordered=TRUE)
div_stats_long$group2 <- factor(div_stats_long$group2, levels=c("0 Weeks", "24 Weeks"), ordered=TRUE)

div_stats_long$Cohort <- factor(div_stats_long$Cohort, levels=c("Naïve", "Exp", "HC"), ordered=TRUE)




```


#### Violin plot
```{r}



#INf long
met_lmer_data_div_long <- pivot_longer(data=met_lmer_data,
                                       cols=div_vars,
                                       values_to="Amount",
                                       names_to="Measure")
                                       
                                       

#Displat week needs to be generated 
met_lmer_data_div_long$DisplayWeek <- factor(met_lmer_data_div_long$DisplayWeek, levels=c("0 Weeks", "24 Weeks"))

div_viol <- ggplot(data=met_lmer_data_div_long, aes(x=DisplayWeek, y=Amount, fill=DisplayWeek))+
                      geom_violin() +
  geom_line(mapping = aes(group = PID),
            position = position_dodge(0.1),
            alpha = .3,
            size=.5) +
  geom_point(mapping = aes(fill=DisplayWeek,group = PID),
             size = 2,
             shape=21,
             position = position_dodge(0.1)) +
  scale_fill_manual(values=c(visitColors[1],visitColors[5]))+
  labs(y="Alpha Diversity Measure", tag="B")+
  theme_classic() +
  theme(legend.position = "none",
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 20),
        axis.text.x = element_text(size = 15, hjust=1, angle=45),
        axis.title.y = element_text(size = 20),
        axis.title.x = element_blank(),
        axis.text.y = element_text(size = 15),
        strip.text.x = element_text(size=12),
        strip.text.y = element_text(size=15),
        plot.tag = element_text(size=25),
        ggh4x.facet.nestline = element_blank(),
        strip.background.x = element_rect(
          color="black", fill="gray", linetype="solid"
        ),
        strip.background.y = element_rect(
          color="black", fill="gray", linetype="solid"
        )) +
  stat_pvalue_manual(
    div_stats_long,
    label = "p.signif",
    hide.ns = TRUE,
    y.position = c(8,140)
  ) +
  facet_nested(rows=vars(Measure),
               cols=vars(Cohort),
               scales="free",
               independent=TRUE)



```



#### Linear Mixed Effects Models  - All Participants

##### Faith
```{r}

div_faith_vars <- c("Faith_Diversity")

#We generate an linear mixed effects model data set to inlcude results
div_faith_lm_data <- unique(expand.grid(div_faith_vars, met_vars))

colnames(div_faith_lm_data) <- c("Predictor","Outcome")
#We generate fields for the statistics
div_faith_lm_data["pval"] <- NA
div_faith_lm_data["padj"] <- NA
div_faith_lm_data["coef"] <- NA
div_faith_lm_data["sig"] <- NA
div_faith_lm_data["percent_variance_exp"] <- NA

for (response in met_vars) { 
  #We pull the confounders for that variable
  conf_r <- get(paste0("conf_vars_",response))
  
  #We add them to the div_faith_vars
  div_faith_vars_full <- c(div_faith_vars,conf_r)
  
  #We remove missing variables
  data_r <- na.omit(met_lmer_data[,c(response,div_faith_vars_full,"PID")])
  
  # create full model 
  ff <- as.formula(paste0(response,"~",paste0(div_faith_vars_full, collapse="+"),"+(1|PID)")) 
  fm <- lmer(ff,
             data = data_r)
  
  predict_fm <- predict(fm)
  sum_fm <- summary(fm)
  
  #Below we calculate the R -suared value
  #First total sum of squares
    tss <- sum((unlist(data_r[,c(response)])-mean(unlist(data_r[,c(response)])))^2)
    #Second residual sum of squares
    rss <- sum((unlist(data_r[,c(response)])-predict_fm)^2)
  #R-squared
  r_squared <- 1-(rss/tss)
  #Percent variance explained
  pve <- r_squared*100
  
  div_faith_lm_data$percent_variance_exp[which(div_faith_lm_data$Outcome==response)] <- pve
  class(pve) <- "numeric"
  
  #We pull out the coefficinets
  coef_fm <- as.data.frame(sum_fm$coefficients)
  coef_fm$padj <- p.adjust(coef_fm$`Pr(>|t|)`, method="fdr")
  
  #Now we go through each predictor and pull out the coefficient in p-value 
  for (pred in div_faith_vars) {
    #We pull the row in the coefficient data set (use substr because sometime strings are added)
    coef_row <- which(substr(rownames(coef_fm),1,nchar(pred))==pred)
    #We not pull the row from the lm data set to put it in
    stat_row <- which(as.character(div_faith_lm_data$Predictor)==pred & as.character(div_faith_lm_data$Outcome)==response)
    #We add an if statemenbt to make sure we only add values when its ad 
    
    if (length(coef_row)==1 & length(stat_row)==1) {
      #We pull out the p-valueand adjusted p-value
      div_faith_lm_data$pval[stat_row] <- coef_fm$`Pr(>|t|)`[coef_row]
      div_faith_lm_data$padj[stat_row] <- coef_fm$padj[coef_row]
      #We pull out the coefficient
      div_faith_lm_data$coef[stat_row] <- coef_fm$Estimate[coef_row]
      
      #Based on the direction we indicate if it is positive of negative
      if (div_faith_lm_data$coef[stat_row]>0) {
        div_faith_lm_data$sig[stat_row] <- "Positive"
      } 
      if (div_faith_lm_data$coef[stat_row]<0) {
        div_faith_lm_data$sig[stat_row] <- "Negative"
      } 
      if (div_faith_lm_data$padj[stat_row]<0.05) {
        div_faith_lm_data$sig[stat_row] <- paste0(div_faith_lm_data$sig[stat_row], " (Significant)")
      }
      
      
      
    }
  }
  
  
}


#We add -C to the LDL and HDL for visualization
div_faith_lm_data$DisplayOutcome <- gsub("DL","DL-C",div_faith_lm_data$Outcome)
#We replace the trig abbreviation with the full Triglycerides name 
div_faith_lm_data$DisplayOutcome <- gsub("Trig","Triglycerides",div_faith_lm_data$DisplayOutcome)
#Now we add the percent variance explained
div_faith_lm_data$DisplayOutcome <- paste0(div_faith_lm_data$DisplayOutcome, " (",round(div_faith_lm_data$percent_variance_exp,1),"% exp)")


div_faith_plot <- ggplot(div_faith_lm_data, aes(x = Predictor, y = DisplayOutcome, color=sig)) +
  scale_color_manual(values=c("lightblue","blue","pink","red"))+
  geom_point(size=5) +
  theme_minimal() +
  labs(x = "Plasma Measure", y = " ", fill=" ", tag="C", title="All Participants") +
  theme_classic() +
  guides(color = guide_legend(ncol = 1))+
  theme(legend.position = "right",
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        axis.text.y = element_text(size=12),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 12, angle=45, hjust=1),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        title = element_text(size=15),
        plot.tag = element_text(size=25))




```

##### Shannon
```{r}

div_shannon_vars <- c("Shannon_Diversity")

#We generate an linear mixed effects model data set to inlcude results
div_shannon_lm_data <- unique(expand.grid(div_shannon_vars, met_vars))

colnames(div_shannon_lm_data) <- c("Predictor","Outcome")
#We generate fields for the statistics
div_shannon_lm_data["pval"] <- NA
div_shannon_lm_data["padj"] <- NA
div_shannon_lm_data["coef"] <- NA
div_shannon_lm_data["sig"] <- NA
div_shannon_lm_data["percent_variance_exp"] <- NA

for (response in met_vars) { 
  #We pull the confounders for that variable
  conf_r <- get(paste0("conf_vars_",response))
  
  #We add them to the div_shannon_vars
  div_shannon_vars_full <- c(div_shannon_vars,conf_r)
  
  #We remove missing variables
  data_r <- na.omit(met_lmer_data[,c(response,div_shannon_vars_full,"PID")])
  
  # create full model 
  ff <- as.formula(paste0(response,"~",paste0(div_shannon_vars_full, collapse="+"),"+(1|PID)")) 
  fm <- lmer(ff,
             data = data_r)
  
  predict_fm <- predict(fm)
  sum_fm <- summary(fm)
  
  #Below we calculate the R -suared value
  #First total sum of squares
    tss <- sum((unlist(data_r[,c(response)])-mean(unlist(data_r[,c(response)])))^2)
    #Second residual sum of squares
    rss <- sum((unlist(data_r[,c(response)])-predict_fm)^2)
  #R-squared
  r_squared <- 1-(rss/tss)
  #Percent variance explained
  pve <- r_squared*100
  
  div_shannon_lm_data$percent_variance_exp[which(div_shannon_lm_data$Outcome==response)] <- pve
  class(pve) <- "numeric"
  
  #We pull out the coefficinets
  coef_fm <- as.data.frame(sum_fm$coefficients)
  coef_fm$padj <- p.adjust(coef_fm$`Pr(>|t|)`, method="fdr")
  
  #Now we go through each predictor and pull out the coefficient in p-value 
  for (pred in div_shannon_vars) {
    #We pull the row in the coefficient data set (use substr because sometime strings are added)
    coef_row <- which(substr(rownames(coef_fm),1,nchar(pred))==pred)
    #We not pull the row from the lm data set to put it in
    stat_row <- which(as.character(div_shannon_lm_data$Predictor)==pred & as.character(div_shannon_lm_data$Outcome)==response)
    #We add an if statemenbt to make sure we only add values when its ad 
    
    if (length(coef_row)==1 & length(stat_row)==1) {
      #We pull out the p-valueand adjusted p-value
      div_shannon_lm_data$pval[stat_row] <- coef_fm$`Pr(>|t|)`[coef_row]
      div_shannon_lm_data$padj[stat_row] <- coef_fm$padj[coef_row]
      #We pull out the coefficient
      div_shannon_lm_data$coef[stat_row] <- coef_fm$Estimate[coef_row]
      
      #Based on the direction we indicate if it is positive of negative
      if (div_shannon_lm_data$coef[stat_row]>0) {
        div_shannon_lm_data$sig[stat_row] <- "Positive"
      } 
      if (div_shannon_lm_data$coef[stat_row]<0) {
        div_shannon_lm_data$sig[stat_row] <- "Negative"
      } 
      if (div_shannon_lm_data$padj[stat_row]<0.05) {
        div_shannon_lm_data$sig[stat_row] <- paste0(div_shannon_lm_data$sig[stat_row], " (Significant)")
      }
      
      
      
    }
  }
  
  
}


#We add -C to the LDL and HDL for visualization
div_shannon_lm_data$DisplayOutcome <- gsub("DL","DL-C",div_shannon_lm_data$Outcome)
#We replace the trig abbreviation with the full Triglycerides name 
div_shannon_lm_data$DisplayOutcome <- gsub("Trig","Triglycerides",div_shannon_lm_data$DisplayOutcome)
#Now we add the percent variance explained
div_shannon_lm_data$DisplayOutcome <- paste0(div_shannon_lm_data$DisplayOutcome, " (",round(div_shannon_lm_data$percent_variance_exp,1),"% exp)")


div_shannon_plot <- ggplot(div_shannon_lm_data, aes(x = Predictor, y = DisplayOutcome, color=sig)) +
  scale_color_manual(values=c("lightblue","pink"))+
  geom_point(size=5) +
  theme_minimal() +
  labs(x = "Plasma Measure", y = " ", fill=" ", tag="D", title="All Participants") +
  theme_classic() +
  guides(color = guide_legend(ncol = 1))+
  theme(legend.position = "right",
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        axis.text.y = element_text(size=12),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 12, angle=45, hjust=1),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        title = element_text(size=15),
        plot.tag = element_text(size=25))

```




#### Linear Mixed Effects Models  - All Participants

##### Faith
```{r}


#We filter the met_lmer_data set to only include naive partiapants

met_lmer_data_naive <- met_lmer_data[which(met_lmer_data$Cohort=="Naïve"),]

div_faith_vars <- c("Faith_Diversity")

#We generate an linear mixed effects model data set to inlcude results
div_faith_lm_naive_data <- unique(expand.grid(div_faith_vars, met_vars))

colnames(div_faith_lm_naive_data) <- c("Predictor","Outcome")
#We generate fields for the statistics
div_faith_lm_naive_data["pval"] <- NA
div_faith_lm_naive_data["padj"] <- NA
div_faith_lm_naive_data["coef"] <- NA
div_faith_lm_naive_data["sig"] <- NA
div_faith_lm_naive_data["percent_variance_exp"] <- NA

for (response in met_vars) { 
  #We pull the confounders for that variable
  conf_r <- setdiff(get(paste0("conf_vars_",response)), "HIV_Status")
  
  #We add them to the div_faith_vars
  div_faith_vars_full <- c(div_faith_vars,conf_r)
  
  #We remove missing variables
  data_r <- na.omit(met_lmer_data_naive[,c(response,div_faith_vars_full,"PID")])
  
  # create full model 
  ff <- as.formula(paste0(response,"~",paste0(div_faith_vars_full, collapse="+"),"+(1|PID)")) 
  fm <- lmer(ff,
             data = data_r)
  
  predict_fm <- predict(fm)
  sum_fm <- summary(fm)
  
  #Below we calculate the R -suared value
  #First total sum of squares
    tss <- sum((unlist(data_r[,c(response)])-mean(unlist(data_r[,c(response)])))^2)
    #Second residual sum of squares
    rss <- sum((unlist(data_r[,c(response)])-predict_fm)^2)
  #R-squared
  r_squared <- 1-(rss/tss)
  #Percent variance explained
  pve <- r_squared*100
  
  div_faith_lm_naive_data$percent_variance_exp[which(div_faith_lm_naive_data$Outcome==response)] <- pve
  class(pve) <- "numeric"
  
  #We pull out the coefficinets
  coef_fm <- as.data.frame(sum_fm$coefficients)
  coef_fm$padj <- p.adjust(coef_fm$`Pr(>|t|)`, method="fdr")
  
  #Now we go through each predictor and pull out the coefficient in p-value 
  for (pred in div_faith_vars) {
    #We pull the row in the coefficient data set (use substr because sometime strings are added)
    coef_row <- which(substr(rownames(coef_fm),1,nchar(pred))==pred)
    #We not pull the row from the lm data set to put it in
    stat_row <- which(as.character(div_faith_lm_naive_data$Predictor)==pred & as.character(div_faith_lm_naive_data$Outcome)==response)
    #We add an if statemenbt to make sure we only add values when its ad 
    
    if (length(coef_row)==1 & length(stat_row)==1) {
      #We pull out the p-valueand adjusted p-value
      div_faith_lm_naive_data$pval[stat_row] <- coef_fm$`Pr(>|t|)`[coef_row]
      div_faith_lm_naive_data$padj[stat_row] <- coef_fm$padj[coef_row]
      #We pull out the coefficient
      div_faith_lm_naive_data$coef[stat_row] <- coef_fm$Estimate[coef_row]
      
      #Based on the direction we indicate if it is positive of negative
      if (div_faith_lm_naive_data$coef[stat_row]>0) {
        div_faith_lm_naive_data$sig[stat_row] <- "Positive"
      } 
      if (div_faith_lm_naive_data$coef[stat_row]<0) {
        div_faith_lm_naive_data$sig[stat_row] <- "Negative"
      } 
      if (div_faith_lm_naive_data$padj[stat_row]<0.05) {
        div_faith_lm_naive_data$sig[stat_row] <- paste0(div_faith_lm_naive_data$sig[stat_row], " (Significant)")
      }
      
      
      
    }
  }
  
  
}


#We add -C to the LDL and HDL for visualization
div_faith_lm_naive_data$DisplayOutcome <- gsub("DL","DL-C",div_faith_lm_naive_data$Outcome)
#We replace the trig abbreviation with the full Triglycerides name 
div_faith_lm_naive_data$DisplayOutcome <- gsub("Trig","Triglycerides",div_faith_lm_naive_data$DisplayOutcome)
#Now we add the percent variance explained
div_faith_lm_naive_data$DisplayOutcome <- paste0(div_faith_lm_naive_data$DisplayOutcome, " (",round(div_faith_lm_naive_data$percent_variance_exp,1),"% exp)")


div_faith_plot_naive <- ggplot(div_faith_lm_naive_data, aes(x = Predictor, y = DisplayOutcome, color=sig)) +
  scale_color_manual(values=c("lightblue","pink"))+
  geom_point(size=5) +
  theme_minimal() +
  labs(x = "Plasma Measure", y = " ", fill=" ", tag="E", title="Naïve Participants") +
  theme_classic() +
  guides(color = guide_legend(ncol = 1))+
  theme(legend.position = "right",
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        axis.text.y = element_text(size=12),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 12, angle=45, hjust=1),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        title = element_text(size=15),
        plot.tag = element_text(size=25))




```

##### Shannon
```{r}

div_shannon_vars <- c("Shannon_Diversity")

#We generate an linear mixed effects model data set to inlcude results
div_shannon_lm_naive_data <- unique(expand.grid(div_shannon_vars, met_vars))

colnames(div_shannon_lm_naive_data) <- c("Predictor","Outcome")
#We generate fields for the statistics
div_shannon_lm_naive_data["pval"] <- NA
div_shannon_lm_naive_data["padj"] <- NA
div_shannon_lm_naive_data["coef"] <- NA
div_shannon_lm_naive_data["sig"] <- NA
div_shannon_lm_naive_data["percent_variance_exp"] <- NA

for (response in met_vars) { 
  #We pull the confounders for that variable
  conf_r <- setdiff(get(paste0("conf_vars_",response)), "HIV_Status")
  
  #We add them to the div_shannon_vars
  div_shannon_vars_full <- c(div_shannon_vars,conf_r)
  
  #We remove missing variables
  data_r <- na.omit(met_lmer_data_naive[,c(response,div_shannon_vars_full,"PID")])
  
  # create full model 
  ff <- as.formula(paste0(response,"~",paste0(div_shannon_vars_full, collapse="+"),"+(1|PID)")) 
  fm <- lmer(ff,
             data = data_r)
  
  predict_fm <- predict(fm)
  sum_fm <- summary(fm)
  
  #Below we calculate the R -suared value
  #First total sum of squares
    tss <- sum((unlist(data_r[,c(response)])-mean(unlist(data_r[,c(response)])))^2)
    #Second residual sum of squares
    rss <- sum((unlist(data_r[,c(response)])-predict_fm)^2)
  #R-squared
  r_squared <- 1-(rss/tss)
  #Percent variance explained
  pve <- r_squared*100
  
  div_shannon_lm_naive_data$percent_variance_exp[which(div_shannon_lm_naive_data$Outcome==response)] <- pve
  class(pve) <- "numeric"
  
  #We pull out the coefficinets
  coef_fm <- as.data.frame(sum_fm$coefficients)
  coef_fm$padj <- p.adjust(coef_fm$`Pr(>|t|)`, method="fdr")
  
  #Now we go through each predictor and pull out the coefficient in p-value 
  for (pred in div_shannon_vars) {
    #We pull the row in the coefficient data set (use substr because sometime strings are added)
    coef_row <- which(substr(rownames(coef_fm),1,nchar(pred))==pred)
    #We not pull the row from the lm data set to put it in
    stat_row <- which(as.character(div_shannon_lm_naive_data$Predictor)==pred & as.character(div_shannon_lm_naive_data$Outcome)==response)
    #We add an if statemenbt to make sure we only add values when its ad 
    
    if (length(coef_row)==1 & length(stat_row)==1) {
      #We pull out the p-valueand adjusted p-value
      div_shannon_lm_naive_data$pval[stat_row] <- coef_fm$`Pr(>|t|)`[coef_row]
      div_shannon_lm_naive_data$padj[stat_row] <- coef_fm$padj[coef_row]
      #We pull out the coefficient
      div_shannon_lm_naive_data$coef[stat_row] <- coef_fm$Estimate[coef_row]
      
      #Based on the direction we indicate if it is positive of negative
      if (div_shannon_lm_naive_data$coef[stat_row]>0) {
        div_shannon_lm_naive_data$sig[stat_row] <- "Positive"
      } 
      if (div_shannon_lm_naive_data$coef[stat_row]<0) {
        div_shannon_lm_naive_data$sig[stat_row] <- "Negative"
      } 
      if (div_shannon_lm_naive_data$padj[stat_row]<0.05) {
        div_shannon_lm_naive_data$sig[stat_row] <- paste0(div_shannon_lm_naive_data$sig[stat_row], " (Significant)")
      }
      
      
      
    }
  }
  
  
}


#We add -C to the LDL and HDL for visualization
div_shannon_lm_naive_data$DisplayOutcome <- gsub("DL","DL-C",div_shannon_lm_naive_data$Outcome)
#We replace the trig abbreviation with the full Triglycerides name 
div_shannon_lm_naive_data$DisplayOutcome <- gsub("Trig","Triglycerides",div_shannon_lm_naive_data$DisplayOutcome)
#Now we add the percent variance explained
div_shannon_lm_naive_data$DisplayOutcome <- paste0(div_shannon_lm_naive_data$DisplayOutcome, " (",round(div_shannon_lm_naive_data$percent_variance_exp,1),"% exp)")


div_shannon_plot_naive <- ggplot(div_shannon_lm_naive_data, aes(x = Predictor, y = DisplayOutcome, color=sig)) +
  scale_color_manual(values=c("lightblue","pink"))+
  geom_point(size=5) +
  theme_minimal() +
  labs(x = "Plasma Measure", y = " ", fill=" ", tag="F", title="Naïve Participants") +
  theme_classic() +
  guides(color = guide_legend(ncol = 1))+
  theme(legend.position = "right",
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        axis.text.y = element_text(size=12),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 12, angle=45, hjust=1),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        title = element_text(size=15),
        plot.tag = element_text(size=25))

```





####Plot Saving
```{r}


saveRDS(alpha_boxplot, file = "../../Figures/Panels/FIGS3A.RDS")
saveRDS(div_viol, file = "../../Figures/Panels/FIGS3B.RDS")
saveRDS(div_faith_plot, file = "../../Figures/Panels/FIGS3C.RDS")
saveRDS(div_shannon_plot, file = "../../Figures/Panels/FIGS3D.RDS")
saveRDS(div_faith_plot_naive, file = "../../Figures/Panels/FIGS3E.RDS")
saveRDS(div_shannon_plot_naive, file = "../../Figures/Panels/FIGS3F.RDS")



```


### Genus Level Analysis


####Cross-Sectional Statistics
```{r}


#We pull the genus variables
gen_names_ind <- colnames(base_with_16S)[315:ncol(base_with_16S)]

#Now we create a data frame to pull median abudnances
gen_names_ind_meds <- as.data.frame(gen_names_ind)
colnames(gen_names_ind_meds) <- "Genus"

gen_names_ind_meds$Median <- NA

for (i in 1:nrow(gen_names_ind_meds)) {
  gen_i <- gen_names_ind_meds$Genus[i]
  gen_names_ind_meds$Median[i] <- median(unlist(base_with_16S[,gen_i]), na.rm=TRUE)
}

gen_names_ind_meds <- gen_names_ind_meds %>%
  arrange(desc(Median))

gen_names_top_50 <- gen_names_ind_meds$Genus[1:50]               


fecal.gen_cs_stats <- gp_stat_sum(data=base_with_16S,               #Data set specified
                                  sub_vars="Week",      #Subset variable for stratification is selected
                                  dep_vars=gen_names_top_50,     #Dependent variables are the met_vars previously defined
                                  gp_var="Cohort",       #Group variable is cohort
                                  normality= TRUE,      #Data has not been normalized so we are doing nonparametric tests
                                  adj="bonferroni"       #p-value adjustment method is Bonferroni
)      



```

####Longtudinal Statistics
```{r}


fecal.gen_long_stats <-long_stat_sum(data=base_with_16S, 
                                  sub_vars="Cohort", 
                                  tm_var="Week", 
                                  dep_vars=gen_names_top_50, 
                                  rand_var="PID", 
                                  normality=FALSE, 
                                  adj="bonferroni", 
                                  pw="separate")      

fecal.gen_long_stats_naive <- fecal.gen_long_stats[which(fecal.gen_long_stats$Cohort=="Naïve"),]
fecal.gen_long_stats_exp <- fecal.gen_long_stats[which(fecal.gen_long_stats$Cohort=="Exp"),]
fecal.gen_long_stats_hc <- fecal.gen_long_stats[which(fecal.gen_long_stats$Cohort=="HC"),]

fecal.gen_long_stats_naive$padj <- p.adjust(fecal.gen_long_stats_naive$`p-value`, method="fdr")
fecal.gen_long_stats_exp$padj <- p.adjust(fecal.gen_long_stats_exp$`p-value`, method="fdr")
fecal.gen_long_stats_hc$padj <- p.adjust(fecal.gen_long_stats_hc$`p-value`, method="fdr")


```


#### Linear Mixed Effects Models  - All Participants

```{r}

mic_16S_vars <- gen_names_ind 

#We generate an linear mixed effects model data set to inlcude results
mic_16S_lm_data <- unique(expand.grid(mic_16S_vars, met_vars))

colnames(mic_16S_lm_data) <- c("Predictor","Outcome")
#We generate fields for the statistics
mic_16S_lm_data["pval"] <- NA
mic_16S_lm_data["padj"] <- NA
mic_16S_lm_data["coef"] <- NA
mic_16S_lm_data["sig"] <- NA
mic_16S_lm_data["percent_variance_exp"] <- NA

for (response in met_vars) { 
  #We pull the confounders for that variable
  conf_r <- get(paste0("conf_vars_",response))
  
  for (pred in gen_names_ind) {
    
    #We add them to the mic_16S_vars
    mic_16S_vars_full <- c(pred,conf_r)
  
    #We remove missing variables
    data_r <- na.omit(base_with_16S[,c(response,mic_16S_vars_full,"PID")])
  
    # create full model 
    ff <- as.formula(paste0(response,"~",paste0(mic_16S_vars_full, collapse="+"),"+(1|PID)")) 
    fm <- lmer(ff,
             data = data_r)
  
    predict_fm <- predict(fm)
    sum_fm <- summary(fm)
  
    #Below we calculate the R -suared value
    #First total sum of squares
    tss <- sum((unlist(data_r[,c(response)])-mean(unlist(data_r[,c(response)])))^2)
    #Second residual sum of squares
    rss <- sum((unlist(data_r[,c(response)])-predict_fm)^2)
    #R-squared
    r_squared <- 1-(rss/tss)
    #Percent variance explained
    pve <- r_squared*100
  
    mic_16S_lm_data$percent_variance_exp[which(mic_16S_lm_data$Outcome==response)] <- pve
    class(pve) <- "numeric"
  
    #We pull out the coefficinets
    coef_fm <- as.data.frame(sum_fm$coefficients)
    coef_fm$padj <- p.adjust(coef_fm$`Pr(>|t|)`, method="fdr")
  
    coef_row <- which(substr(rownames(coef_fm),1,nchar(pred))==pred)
    #We not pull the row from the lm data set to put it in
    stat_row <- which(as.character(mic_16S_lm_data$Predictor)==pred & as.character(mic_16S_lm_data$Outcome)==response)
    #We add an if statemenbt to make sure we only add values when its ad 
    
    if (length(coef_row)==1 & length(stat_row)==1) {
      #We pull out the p-valueand adjusted p-value
      mic_16S_lm_data$pval[stat_row] <- coef_fm$`Pr(>|t|)`[coef_row]

      #We pull out the coefficient
      mic_16S_lm_data$coef[stat_row] <- coef_fm$Estimate[coef_row]
      
    }
  }
}

mic_16S_lm_data$padj[which(mic_16S_lm_data$Outcome=="HDL")] <- p.adjust(mic_16S_lm_data$pval[which(mic_16S_lm_data$Outcome=="HDL")], method="fdr")
mic_16S_lm_data$padj[which(mic_16S_lm_data$Outcome=="LDL")] <- p.adjust(mic_16S_lm_data$pval[which(mic_16S_lm_data$Outcome=="LDL")], method="fdr")
mic_16S_lm_data$padj[which(mic_16S_lm_data$Outcome=="Trig")] <- p.adjust(mic_16S_lm_data$pval[which(mic_16S_lm_data$Outcome=="Trig")], method="fdr")
mic_16S_lm_data$padj[which(mic_16S_lm_data$Outcome=="Glucose")] <- p.adjust(mic_16S_lm_data$pval[which(mic_16S_lm_data$Outcome=="Glucose")], method="fdr")


mic_16S_lm_data$sig[which(mic_16S_lm_data$coef>0)] <- "Positive"
mic_16S_lm_data$sig[which(mic_16S_lm_data$coef<0)] <- "Negative"
mic_16S_lm_data$sig[which(mic_16S_lm_data$padj<0.05)] <- paste0(mic_16S_lm_data$sig[which(mic_16S_lm_data$padj<0.05)],"(Significant)")


#We add -C to the LDL and HDL for visualization
mic_16S_lm_data$DisplayOutcome <- gsub("DL","DL-C",mic_16S_lm_data$Outcome)
#We replace the trig abbreviation with the full Triglycerides name 
mic_16S_lm_data$DisplayOutcome <- gsub("Trig","Triglycerides",mic_16S_lm_data$DisplayOutcome)
#Now we add the percent variance explained
mic_16S_lm_data$DisplayOutcome <- paste0(mic_16S_lm_data$DisplayOutcome, " (",round(mic_16S_lm_data$percent_variance_exp,1),"% exp)")


mic_16S_plot <- ggplot(mic_16S_lm_data, aes(x = Predictor, y = DisplayOutcome, color=sig)) +
  scale_color_manual(values=c("lightblue","pink","red"))+
  geom_point(size=5) +
  theme_minimal() +
  labs(x = "Plasma Measure", y = " ", fill=" ", tag="C", title="All Participants") +
  theme_classic() +
  guides(color = guide_legend(ncol = 1))+
  theme(legend.position = "right",
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        axis.text.y = element_text(size=12),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 12, angle=45, hjust=1),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        title = element_text(size=15),
        plot.tag = element_text(size=25))

sig_taxa_ind <- mic_16S_lm_data$Predictor[which(mic_16S_lm_data$padj<0.05)]

mic_16S_lm_data_sig_data <- mic_16S_lm_data[which(mic_16S_lm_data$Predictor %in% sig_taxa_ind),]

mic_16S_lm_data_sig_data$DisplayGenus <- ""
for (r in 1:nrow(mic_16S_lm_data_sig_data)) {
  gen_ind_r <- as.numeric(substr(mic_16S_lm_data_sig_data$Predictor[r],7,nchar(as.character(mic_16S_lm_data_sig_data$Predictor[r]))))-1
  genus_name_r <-fecal.gen.names[gen_ind_r]
  mic_16S_lm_data_sig_data$DisplayGenus[r] <- genus_name_r
}

mic_16S_plot_sig <- ggplot(mic_16S_lm_data_sig_data, aes(x = DisplayGenus, y = DisplayOutcome, color=sig)) +
  scale_color_manual(values=c("lightblue","pink","red"))+
  geom_point(size=5) +
  theme_minimal() +
  labs(x = "Plasma Measure", y = " ", fill=" ", tag="A", title="All Participants") +
  theme_classic() +
  guides(color = guide_legend(ncol = 1))+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        axis.text.y = element_text(size=12),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 12, angle=45, hjust=1),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        title = element_text(size=15),
        plot.tag = element_text(size=25))


```



#### Linear Mixed Effects Models  - Naive Participants

```{r}


base_with_16S_naive <- base_with_16S[which(base_with_16S$Cohort=="Naïve"),]
mic_16S_naive_vars <- gen_names_ind 

#We generate an linear mixed effects model data set to inlcude results
mic_16S_naive_lm_data <- unique(expand.grid(mic_16S_naive_vars, met_vars))

colnames(mic_16S_naive_lm_data) <- c("Predictor","Outcome")
#We generate fields for the statistics
mic_16S_naive_lm_data["pval"] <- NA
mic_16S_naive_lm_data["padj"] <- NA
mic_16S_naive_lm_data["coef"] <- NA
mic_16S_naive_lm_data["sig"] <- NA
mic_16S_naive_lm_data["percent_variance_exp"] <- NA

for (response in met_vars) { 
  #We pull the confounders for that variable
  conf_r <- get(paste0("conf_vars_",response))
  
  for (pred in gen_names_ind) {
    
    #We add them to the mic_16S_naive_vars
    mic_16S_naive_vars_full <- setdiff(c(pred,conf_r),"HIV_Status")
    
    #We remove missing variables
    data_r <- na.omit(base_with_16S_naive[,c(response,mic_16S_naive_vars_full,"PID")])
    
    # create full model 
    ff <- as.formula(paste0(response,"~",paste0(mic_16S_naive_vars_full, collapse="+"),"+(1|PID)")) 
    fm <- lmer(ff,
               data = data_r)
    
    predict_fm <- predict(fm)
    sum_fm <- summary(fm)
    
    #Below we calculate the R -suared value
    #First total sum of squares
    tss <- sum((unlist(data_r[,c(response)])-mean(unlist(data_r[,c(response)])))^2)
    #Second residual sum of squares
    rss <- sum((unlist(data_r[,c(response)])-predict_fm)^2)
    #R-squared
    r_squared <- 1-(rss/tss)
    #Percent variance explained
    pve <- r_squared*100
    
    mic_16S_naive_lm_data$percent_variance_exp[which(mic_16S_naive_lm_data$Outcome==response)] <- pve
    class(pve) <- "numeric"
    
    #We pull out the coefficinets
    coef_fm <- as.data.frame(sum_fm$coefficients)
    coef_fm$padj <- p.adjust(coef_fm$`Pr(>|t|)`, method="fdr")
    
    coef_row <- which(substr(rownames(coef_fm),1,nchar(pred))==pred)
    #We not pull the row from the lm data set to put it in
    stat_row <- which(as.character(mic_16S_naive_lm_data$Predictor)==pred & as.character(mic_16S_naive_lm_data$Outcome)==response)
    #We add an if statemenbt to make sure we only add values when its ad 
    
    if (length(coef_row)==1 & length(stat_row)==1) {
      #We pull out the p-valueand adjusted p-value
      mic_16S_naive_lm_data$pval[stat_row] <- coef_fm$`Pr(>|t|)`[coef_row]
      
      #We pull out the coefficient
      mic_16S_naive_lm_data$coef[stat_row] <- coef_fm$Estimate[coef_row]
      
    }
  }
}

mic_16S_naive_lm_data$padj[which(mic_16S_naive_lm_data$Outcome=="HDL")] <- p.adjust(mic_16S_naive_lm_data$pval[which(mic_16S_naive_lm_data$Outcome=="HDL")], method="fdr")
mic_16S_naive_lm_data$padj[which(mic_16S_naive_lm_data$Outcome=="LDL")] <- p.adjust(mic_16S_naive_lm_data$pval[which(mic_16S_naive_lm_data$Outcome=="LDL")], method="fdr")
mic_16S_naive_lm_data$padj[which(mic_16S_naive_lm_data$Outcome=="Trig")] <- p.adjust(mic_16S_naive_lm_data$pval[which(mic_16S_naive_lm_data$Outcome=="Trig")], method="fdr")
mic_16S_naive_lm_data$padj[which(mic_16S_naive_lm_data$Outcome=="Glucose")] <- p.adjust(mic_16S_naive_lm_data$pval[which(mic_16S_naive_lm_data$Outcome=="Glucose")], method="fdr")


mic_16S_naive_lm_data$sig[which(mic_16S_naive_lm_data$coef>0)] <- "Positive"
mic_16S_naive_lm_data$sig[which(mic_16S_naive_lm_data$coef<0)] <- "Negative"
mic_16S_naive_lm_data$sig[which(mic_16S_naive_lm_data$padj<0.05)] <- paste0(mic_16S_naive_lm_data$sig[which(mic_16S_naive_lm_data$padj<0.05)],"(Significant)")


#We add -C to the LDL and HDL for visualization
mic_16S_naive_lm_data$DisplayOutcome <- gsub("DL","DL-C",mic_16S_naive_lm_data$Outcome)
#We replace the trig abbreviation with the full Triglycerides name 
mic_16S_naive_lm_data$DisplayOutcome <- gsub("Trig","Triglycerides",mic_16S_naive_lm_data$DisplayOutcome)
#Now we add the percent variance explained
mic_16S_naive_lm_data$DisplayOutcome <- paste0(mic_16S_naive_lm_data$DisplayOutcome, " (",round(mic_16S_naive_lm_data$percent_variance_exp,1),"% exp)")


mic_16S_naive_plot <- ggplot(mic_16S_naive_lm_data, aes(x = Predictor, y = DisplayOutcome, color=sig)) +
  scale_color_manual(values=c("lightblue","pink","red"))+
  geom_point(size=5) +
  theme_minimal() +
  labs(x = "Plasma Measure", y = " ", fill=" ", tag="C", title="All Participants") +
  theme_classic() +
  guides(color = guide_legend(ncol = 1))+
  theme(legend.position = "right",
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        axis.text.y = element_text(size=12),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 12, angle=45, hjust=1),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        title = element_text(size=15),
        plot.tag = element_text(size=25))

sig_taxa_ind <- mic_16S_naive_lm_data$Predictor[which(mic_16S_naive_lm_data$padj<0.05)]

```


####Plot Saving
```{r}

saveRDS(mic_16S_plot, file = "../../Figures/Panels/FIGS4A.RDS")

```

###Beta Diveristy

####Weighted UniFrac

#####Ordination Plot

```{r}

fecal.WU.pc.data <- inner_join(fecal.wu.biplot[["data"]][["Vectors"]],base, by="SampleID")


PCvector_WU <- paste0("PC",1:231)
PCvector_squared_WU <- paste0(PCvector_WU,"^2")
PCvector_squared_combined_WU <- paste0(PCvector_squared_WU, collapse=" + ")



fecal.WU.contrib <-fecal.wu.biplot[["data"]][["Species"]]

fecal.features_12_WU <- fecal.WU.contrib %>%
  rowwise() %>%
  mutate(contribution12 = sqrt(PC1^2 + PC2^2), ) %>%
  arrange(desc(contribution12))

fecal.features_34_WU <- fecal.WU.contrib %>%
  rowwise() %>%
  mutate(contribution34 = sqrt(PC3^2 + PC4^2), ) %>%
  arrange(desc(contribution34))

fecal.features_12_WU$Family <- "Unclassified" 
fecal.features_12_WU$Genus <- "Unclassified"

fecal.features_34_WU$Family <- "Unclassified" 
fecal.features_34_WU$Genus <- "Unclassified"

fecal.tax <- as.data.frame(fecal.tax.plot.data@tax_table)

for (k in 1:nrow(fecal.features_12_WU)) {
  feat.k_12 <- fecal.features_12_WU$FeatureID[k]
  fecal.gen.k_12 <- fecal.tax$Genus[which(rownames(fecal.tax)==feat.k_12)]
  fecal.fam.k_12 <- fecal.tax$Family[which(rownames(fecal.tax)==feat.k_12)]
  if (length(fecal.gen.k_12)==1) { 
    if (!is.na(fecal.gen.k_12)) {
     fecal.features_12_WU$Genus[k] <- fecal.gen.k_12  
    }
  }
  if (length(fecal.fam.k_12)==1) {
    if (!is.na(fecal.fam.k_12)) {
      fecal.features_12_WU$Family[k] <- fecal.fam.k_12 
    }
  }
  
  
  feat.k_34 <- fecal.features_34_WU$FeatureID[k]
  fecal.gen.k_34 <- fecal.tax$Genus[which(rownames(fecal.tax)==feat.k_34)]
  fecal.fam.k_34 <- fecal.tax$Family[which(rownames(fecal.tax)==feat.k_34)]
  if (length(fecal.gen.k_34)==1) { 
    if (!is.na(fecal.gen.k_34)) {
     fecal.features_34_WU$Genus[k] <- fecal.gen.k_34  
    }
  }
  if (length(fecal.fam.k_34)==1) {
    if (!is.na(fecal.fam.k_34)) {
      fecal.features_34_WU$Family[k] <- fecal.fam.k_34 
    }
  }
  
}

fecal.top_ten_12_WU <- fecal.features_12_WU[which(fecal.features_12_WU$contribution12>0.017),]

fecal.top_ten_34_WU <- fecal.features_34_WU[which(fecal.features_34_WU$contribution34>0.0277),]


fecal.WU.pc.data$Cohort_Week <- paste0(fecal.WU.pc.data$Cohort," - ", fecal.WU.pc.data$Week, " Weeks")
fecal.WU.pc.data$DisplayWeek <- paste0(fecal.WU.pc.data$Week, " Weeks")

fecal.mic_arrows_12_WU <- data.frame(
  xstart = rep(0,10),  # Replace with your actual x-coordinate start points
  ystart = rep(0,10),  # Replace with your actual y-coordinate start points
  xend = (8)*fecal.top_ten_12_WU$PC1,  # Replace with your actual x-coordinate end points
  yend = (8)*fecal.top_ten_12_WU$PC2,  # Replace with your actual y-coordinate end points
  label=fecal.top_ten_12_WU$Genus
)

fecal.mic_arrows_34_WU <- data.frame(
  xstart = rep(0,10),  # Replace with your actual x-coordinate start points
  ystart = rep(0,10),  # Replace with your actual y-coordinate start points
  xend = (8)*fecal.top_ten_34_WU$PC3,  # Replace with your actual x-coordinate end points
  yend = (8)*fecal.top_ten_34_WU$PC4,  # Replace with your actual y-coordinate end points
  label=fecal.top_ten_34_WU$Genus
)




fecal.mic_pcoaplot_biplot_12_samples <- ggplot(data = fecal.WU.pc.data, size=2, alpha=.5, aes(x = as.numeric(fecal.WU.pc.data$PC1), y = as.numeric(fecal.WU.pc.data$PC2))) + 
  geom_point(data=fecal.WU.pc.data,aes(fill=fecal.WU.pc.data$Cohort_Week, color=fecal.WU.pc.data$Cohort_Week), shape=21, size=3, stroke=1, alpha=0.5)+
  geom_line(size=.5, alpha=.3, aes(group= fecal.WU.pc.data$PID))+
  stat_ellipse(geom="polygon",
               aes(fill= fecal.WU.pc.data$Cohort_Week, color=fecal.WU.pc.data$Cohort_Week),
               alpha=0.25)+
  scale_fill_manual(values=c("#A6611A","#A6611A","gray","gray","#018571","#018571"), name="Cohort")+
  scale_color_manual(values=c("#A6611A","black","gray","black","#018571","black"), name="Cohort")+  
  labs(x="PC1", y="PC2", key=" ", tag="B")+
  guides(color=guide_legend(nrow=3,bycol=TRUE))+
  theme_bw()+
  theme(title=element_text(size=15),
        axis.text.y=element_text(size=15),
        axis.text.x=element_text(size=15),
        strip.text.y = element_text(size=15),
        strip.text.x = element_text(size=15),
        axis.title = element_text(size=15),
        axis.title.y.right = element_text(size = 15),
        legend.text=element_text(size=9),
        plot.tag = element_text(size=25),
        legend.title=element_blank(),
        legend.position = "right")


x_limits_WU_12 <- ggplot_build(fecal.mic_pcoaplot_biplot_12_samples)$layout$panel_params[[1]]$x.range
y_limits_WU_12 <- ggplot_build(fecal.mic_pcoaplot_biplot_12_samples)$layout$panel_params[[1]]$y.range


fecal.mic_pcoaplot_biplot_12_arrows <- ggplot(data = fecal.WU.pc.data, size=2, alpha=.5, aes(x = as.numeric(fecal.WU.pc.data$PC1), y = as.numeric(fecal.WU.pc.data$PC2))) +  
    labs(x="PC1", y="PC2", key=" ", tag="C")+
  geom_segment(data = fecal.mic_arrows_12_WU, aes(x = xstart, y = ystart, xend = xend, yend = yend),arrow = arrow(length = unit(0.3, "cm")), color="red", inherit.aes = FALSE)+
  geom_label_repel(data=fecal.mic_arrows_12_WU, aes(x = fecal.mic_arrows_12_WU$xend, y = fecal.mic_arrows_12_WU$yend, label=fecal.mic_arrows_12_WU$label), size=4, color="red", fill="white", inherit.aes = FALSE)+
  guides(color=guide_legend(nrow=1,bycol=TRUE))+

              coord_cartesian(xlim = x_limits_WU_12,
                            ylim = y_limits_WU_12) +
  theme_bw()+
  theme(title=element_text(size=15),
        axis.text.y=element_text(size=15),
        axis.text.x=element_text(size=15),
        strip.text.y = element_text(size=15),
        strip.text.x = element_text(size=15),
        axis.title = element_text(size=15),
        axis.title.y.right = element_text(size = 15),
        legend.text=element_text(size=15),
        plot.tag = element_text(size=25),
        legend.title=element_blank(),
        legend.position = "bottom")

fecal.mic_pcoaplot_biplot_34_samples <- ggplot(data = fecal.WU.pc.data, size=2, alpha=.5, aes(x = as.numeric(fecal.WU.pc.data$PC3), y = as.numeric(fecal.WU.pc.data$PC4))) + 
  geom_point(data=fecal.WU.pc.data,aes(fill=fecal.WU.pc.data$Cohort_Week, color=fecal.WU.pc.data$Cohort_Week), shape=21, size=3, stroke=1, alpha=0.5)+
  geom_line(size=.5, alpha=.3, aes(group= fecal.WU.pc.data$PID))+
  stat_ellipse(geom="polygon",
               aes(fill= fecal.WU.pc.data$Cohort_Week, color=fecal.WU.pc.data$Cohort_Week),
               alpha=0.25)+
  scale_fill_manual(values=c("#A6611A","#A6611A","gray","gray","#018571","#018571"), name="Cohort")+
  scale_color_manual(values=c("#A6611A","black","gray","black","#018571","black"), name="Cohort")+  
  labs(x="PC3", y="PC4", key=" ", tag="D")+
  guides(color=guide_legend(nrow=3,bycol=TRUE))+
  theme_bw()+
  theme(title=element_text(size=15),
        axis.text.y=element_text(size=15),
        axis.text.x=element_text(size=15),
        strip.text.y = element_text(size=15),
        strip.text.x = element_text(size=15),
        axis.title = element_text(size=15),
        axis.title.y.right = element_text(size = 15),
        legend.text=element_text(size=15),
        plot.tag = element_text(size=25),
        legend.title=element_blank(),
        legend.position = "right")


x_limits_WU_34 <- ggplot_build(fecal.mic_pcoaplot_biplot_34_samples)$layout$panel_params[[1]]$x.range
y_limits_WU_34 <- ggplot_build(fecal.mic_pcoaplot_biplot_34_samples)$layout$panel_params[[1]]$y.range


fecal.mic_pcoaplot_biplot_34_arrows <- ggplot(data = fecal.WU.pc.data, size=2, alpha=.5, aes(x = as.numeric(fecal.WU.pc.data$PC3), y = as.numeric(fecal.WU.pc.data$PC4))) +  
  labs(x="PC3", y="PC4", key=" ", tag="E")+
  geom_segment(data = fecal.mic_arrows_34_WU, aes(x = xstart, y = ystart, xend = xend, yend = yend),arrow = arrow(length = unit(0.3, "cm")), color="red", inherit.aes = FALSE)+
  geom_label_repel(data=fecal.mic_arrows_34_WU, aes(x = fecal.mic_arrows_34_WU$xend, y = fecal.mic_arrows_34_WU$yend, label=fecal.mic_arrows_34_WU$label), size=4, color="red", fill="white", inherit.aes = FALSE)+
  guides(color=guide_legend(nrow=1,bycol=TRUE))+
  
  coord_cartesian(xlim = x_limits_WU_34,
                  ylim = y_limits_WU_34) +
  theme_bw()+
  theme(title=element_text(size=15),
        axis.text.y=element_text(size=15),
        axis.text.x=element_text(size=15),
        strip.text.y = element_text(size=15),
        strip.text.x = element_text(size=15),
        axis.title = element_text(size=15),
        axis.title.y.right = element_text(size = 15),
        legend.text=element_text(size=15),
        plot.tag = element_text(size=25),
        legend.title=element_blank(),
        legend.position = "bottom")




```




#####Full Model PCs
```{r}


mic_pc_vars <- c("PC1","PC2","PC3","PC4")

#We generate an linear mixed effects model data set to inlcude results
mic_pc_lm_data <- unique(expand.grid(mic_pc_vars, met_vars))

colnames(mic_pc_lm_data) <- c("Predictor","Outcome")
#We generate fields for the statistics
mic_pc_lm_data["pval"] <- NA
mic_pc_lm_data["padj"] <- NA
mic_pc_lm_data["coef"] <- NA
mic_pc_lm_data["sig"] <- NA
mic_pc_lm_data["percent_variance_exp"] <- NA

for (response in met_vars) { 
  #We pull the confounders for that variable
  conf_r <- get(paste0("conf_vars_",response))
  
  #We add them to the mic_pc_vars
  mic_pc_vars_full <- c(mic_pc_vars,conf_r)
  
  #We remove missing variables
  data_r <- na.omit(fecal.WU.pc.data[,c(response,mic_pc_vars_full,"PID")])
  
  # create full model 
  ff <- as.formula(paste0(response,"~",paste0(mic_pc_vars_full, collapse="+"),"+(1|PID)")) 
  fm <- lmer(ff,
             data = data_r)
  
  predict_fm <- predict(fm)
  sum_fm <- summary(fm)
  
  #Below we calculate the R -suared value
  #First total sum of squares
  tss <- sum((unlist(data_r[,c(response)])-mean(unlist(data_r[,c(response)])))^2)
  #Second residual sum of squares
  rss <- sum((unlist(data_r[,c(response)])-predict_fm)^2)
  #R-squared
  r_squared <- 1-(rss/tss)
  #Percent variance explained
  pve <- r_squared*100
  
  mic_pc_lm_data$percent_variance_exp[which(mic_pc_lm_data$Outcome==response)] <- pve
  class(pve) <- "numeric"
  
  #We pull out the coefficinets
  coef_fm <- as.data.frame(sum_fm$coefficients)
  coef_fm$padj <- p.adjust(coef_fm$`Pr(>|t|)`, method="fdr")
  
  #Now we go through each predictor and pull out the coefficient in p-value 
  for (pred in mic_pc_vars) {
    #We pull the row in the coefficient data set (use substr because sometime strings are added)
    coef_row <- which(substr(rownames(coef_fm),1,nchar(pred))==pred)
    #We not pull the row from the lm data set to put it in
    stat_row <- which(as.character(mic_pc_lm_data$Predictor)==pred & as.character(mic_pc_lm_data$Outcome)==response)
    #We add an if statemenbt to make sure we only add values when its ad 
    
    if (length(coef_row)==1 & length(stat_row)==1) {
      #We pull out the p-valueand adjusted p-value
      mic_pc_lm_data$pval[stat_row] <- coef_fm$`Pr(>|t|)`[coef_row]
      mic_pc_lm_data$padj[stat_row] <- coef_fm$padj[coef_row]
      #We pull out the coefficient
      mic_pc_lm_data$coef[stat_row] <- coef_fm$Estimate[coef_row]
      
      #Based on the direction we indicate if it is positive of negative
      if (mic_pc_lm_data$coef[stat_row]>0) {
        mic_pc_lm_data$sig[stat_row] <- "Positive"
      } 
      if (mic_pc_lm_data$coef[stat_row]<0) {
        mic_pc_lm_data$sig[stat_row] <- "Negative"
      } 
      if (mic_pc_lm_data$padj[stat_row]<0.05) {
        mic_pc_lm_data$sig[stat_row] <- paste0(mic_pc_lm_data$sig[stat_row], " (Significant)")
      }
      
      
      
    }
  }
  
  
}


#We add -C to the LDL and HDL for visualization
mic_pc_lm_data$DisplayOutcome <- gsub("DL","DL-C",mic_pc_lm_data$Outcome)
#We replace the trig abbreviation with the full Triglycerides name 
mic_pc_lm_data$DisplayOutcome <- gsub("Trig","Triglycerides",mic_pc_lm_data$DisplayOutcome)
#Now we add the percent variance explained
mic_pc_lm_data$DisplayOutcome <- paste0(mic_pc_lm_data$DisplayOutcome, " (",round(mic_pc_lm_data$percent_variance_exp,1),"% exp)")


mic_pc_plot <- ggplot(mic_pc_lm_data, aes(x = Predictor, y = DisplayOutcome, color=sig)) +
  scale_color_manual(values=c("lightblue","pink","red"))+
  geom_point(size=5) +
  theme_minimal() +
  labs(x = "Plasma Measure", y = " ", fill=" ", tag="F", title="All Participants") +
  theme_classic() +
  guides(color = guide_legend(ncol = 1))+
  theme(legend.position = "right",
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        axis.text.y = element_text(size=12),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 12, angle=45, hjust=1),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        title = element_text(size=15),
        plot.tag = element_text(size=25))





```



#####Full Model PCs - Naive
```{r}
#We filter the fecal.WU.pc.data set to only include naive partiapants

fecal.WU.pc.data_naive <- fecal.WU.pc.data[which(fecal.WU.pc.data$Cohort=="Naïve"),]

#We generate an linear mixed effects model data set to inlcude results
mic_pc_lm_naive_data <- unique(expand.grid(mic_pc_vars, met_vars))

colnames(mic_pc_lm_naive_data) <- c("Predictor","Outcome")
#We generate fields for the statistics
mic_pc_lm_naive_data["pval"] <- NA
mic_pc_lm_naive_data["padj"] <- NA
mic_pc_lm_naive_data["coef"] <- NA
mic_pc_lm_naive_data["sig"] <- NA
mic_pc_lm_naive_data["percent_variance_exp"] <- NA

for (response in met_vars) { 
  #We pull the confounders for that variable
  conf_r <- setdiff(get(paste0("conf_vars_",response)), "HIV_Status")
  
  #We add them to the mic_pc_vars
  mic_pc_vars_full <- c(mic_pc_vars,conf_r)
  
  #We remove missing variables
  data_r <- na.omit(fecal.WU.pc.data_naive[,c(response,mic_pc_vars_full,"PID")])
  
  # create full model 
  ff <- as.formula(paste0(response,"~",paste0(mic_pc_vars_full, collapse="+"),"+(1|PID)")) 
  fm <- lmer(ff,
             data = data_r)
  
  predict_fm <- predict(fm)
  sum_fm <- summary(fm)
  
  #Below we calculate the R -suared value
  #First total sum of squares
  tss <- sum((unlist(data_r[,c(response)])-mean(unlist(data_r[,c(response)])))^2)
  #Second residual sum of squares
  rss <- sum((unlist(data_r[,c(response)])-predict_fm)^2)
  #R-squared
  r_squared <- 1-(rss/tss)
  #Percent variance explained
  pve <- r_squared*100
  
  mic_pc_lm_naive_data$percent_variance_exp[which(mic_pc_lm_naive_data$Outcome==response)] <- pve
  class(pve) <- "numeric"
  
  #We pull out the coefficinets
  coef_fm <- as.data.frame(sum_fm$coefficients)
  coef_fm$padj <- p.adjust(coef_fm$`Pr(>|t|)`, method="fdr")
  
  #Now we go through each predictor and pull out the coefficient in p-value 
  for (pred in mic_pc_vars) {
    #We pull the row in the coefficient data set (use substr because sometime strings are added)
    coef_row <- which(substr(rownames(coef_fm),1,nchar(pred))==pred)
    #We not pull the row from the lm data set to put it in
    stat_row <- which(as.character(mic_pc_lm_naive_data$Predictor)==pred & as.character(mic_pc_lm_naive_data$Outcome)==response)
    #We add an if statemenbt to make sure we only add values when its ad 
    
    if (length(coef_row)==1 & length(stat_row)==1) {
      #We pull out the p-valueand adjusted p-value
      mic_pc_lm_naive_data$pval[stat_row] <- coef_fm$`Pr(>|t|)`[coef_row]
      mic_pc_lm_naive_data$padj[stat_row] <- coef_fm$padj[coef_row]
      #We pull out the coefficient
      mic_pc_lm_naive_data$coef[stat_row] <- coef_fm$Estimate[coef_row]
      
      #Based on the direction we indicate if it is positive of negative
      if (mic_pc_lm_naive_data$coef[stat_row]>0) {
        mic_pc_lm_naive_data$sig[stat_row] <- "Positive"
      } 
      if (mic_pc_lm_naive_data$coef[stat_row]<0) {
        mic_pc_lm_naive_data$sig[stat_row] <- "Negative"
      } 
      if (mic_pc_lm_naive_data$padj[stat_row]<0.05) {
        mic_pc_lm_naive_data$sig[stat_row] <- paste0(mic_pc_lm_naive_data$sig[stat_row], " (Significant)")
      }
      
      
      
    }
  }
  
  
}


#We add -C to the LDL and HDL for visualization
mic_pc_lm_naive_data$DisplayOutcome <- gsub("DL","DL-C",mic_pc_lm_naive_data$Outcome)
#We replace the trig abbreviation with the full Triglycerides name 
mic_pc_lm_naive_data$DisplayOutcome <- gsub("Trig","Triglycerides",mic_pc_lm_naive_data$DisplayOutcome)
#Now we add the percent variance explained
mic_pc_lm_naive_data$DisplayOutcome <- paste0(mic_pc_lm_naive_data$DisplayOutcome, " (",round(mic_pc_lm_naive_data$percent_variance_exp,1),"% exp)")


mic_pc_plot_naive <- ggplot(mic_pc_lm_naive_data, aes(x = Predictor, y = DisplayOutcome, color=sig)) +
  scale_color_manual(values=c("lightblue","pink","red"))+
  geom_point(size=5) +
  theme_minimal() +
  labs(x = "Plasma Measure", y = " ", fill=" ", tag="G", title="Naïve Participants") +
  theme_classic() +
  guides(color = guide_legend(ncol = 1))+
  theme(legend.position = "right",
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        axis.text.y = element_text(size=12),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 12, angle=45, hjust=1),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        title = element_text(size=15),
        plot.tag = element_text(size=25))




```

####Plot Saving
```{r}

saveRDS(mic_16S_plot_sig, file = "../../Figures/Panels/FIGS4A.RDS")
saveRDS(fecal.mic_pcoaplot_biplot_12_samples, file = "../../Figures/Panels/FIGS4B.RDS")
saveRDS(fecal.mic_pcoaplot_biplot_12_arrows, file = "../../Figures/Panels/FIGS4C.RDS")
saveRDS(fecal.mic_pcoaplot_biplot_34_samples, file = "../../Figures/Panels/FIGS4D.RDS")
saveRDS(fecal.mic_pcoaplot_biplot_34_arrows, file = "../../Figures/Panels/FIGS4E.RDS")
saveRDS(mic_pc_plot, file = "../../Figures/Panels/FIGS4F.RDS")
saveRDS(mic_pc_plot_naive, file = "../../Figures/Panels/FIGS4G.RDS")
```

