---
title: "Inflammation and Immune Analysis"
author: "J. O'Connor"
date: "2025-09-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document competes the analysis comparing Inflammatory markers CRP and IL-6 (measured by ELISA) and immune cells (measured by Flow cytometry).

### Function Sourcing

First the functions are all sourced
```{r Functions, message=FALSE, warning=FALSE}
#To access the functions directory why must direct to the parent directory
setwd("../..")

#A list of the function files is pulled
function_files <- list.files(paste0(getwd(),"/Functions"), pattern = "\\.R$", full.names = TRUE)
#Those functions are then sourced
lapply(function_files, source)
```


### Data Loading

We load all the data of interest

```{r data_load, echo=FALSE}
#All Metadata objects have been stored in one location
metadata_objects <- readRDS("~/Zimbabwe-Cardiometabolic-Analysis/Data/R_Data/metadata_objects.RDS")

#Metdata objects
  #base: all processed metadata
  base <- metadata_objects$base
  
#Previusly Determined confounders are loaded
conf_vars <- readRDS("~/Zimbabwe-Cardiometabolic-Analysis/Data/R_Data/conf_vars.RDS")

#Confounders
  #conf_vars_all: All confounders in one vector
  #conf_vars_HDL: Confounders of HDL
  #conf_vars_LDL: Confounders of LDL
  #conf_vars_Trig: Confounders of Trig
  #conf_vars_Glucose: Confounders of Glucose
  conf_vars_all <- conf_vars$conf_vars_all
  conf_vars_HDL <- conf_vars$conf_vars_HDL
  conf_vars_LDL <- conf_vars$conf_vars_LDL
  conf_vars_Trig <- conf_vars$conf_vars_Trig
  conf_vars_Glucose <- conf_vars$conf_vars_Glucose

```


### Inflammatory Measures

#### Cross Sectional Differences
```{r}
#Cardioetabolic outcome variables are defined

#HDL: plasma high-density lipoprotein cholesterol (HDL-C)
#LDL: plasma low-density lipoprotein cholesterol (HDL-C)
#Trig: plasma triglycerides
#Glucose: Plasma glucose

met_vars <- c("HDL",
              "LDL",
              "Trig",
              "Glucose")

#Inflammatory Measures are defined

#IL6: plasma interleukin-6 
#CRP: plasma C-reactive protein(mg/l)

inf_vars <- c("CRP",
              "IL6")

#A dislay week helps for the plots (add a weeks label
base$DisplayWeek <- paste0(base$Week, " Weeks")
#The variables are generated by transformaing the data
#met_lmer data is created from the base metadata file
met_lmer_data <- base
met_lmer_data$CRP <- as.numeric(met_lmer_data$CRP_mg_L)
met_lmer_data$IL6 <- as.numeric(met_lmer_data$`IL-6_pg_mL`)

#Log tranformation
met_lmer_data$LogCRP <- log10(as.numeric(met_lmer_data$CRP))
met_lmer_data$LogIL6 <- log10(as.numeric(met_lmer_data$IL6))
met_lmer_data$LogCRP[which(!is.finite(met_lmer_data$LogCRP))] <- NA
met_lmer_data$LogIL6[which(!is.finite(met_lmer_data$LogIL6))] <- NA


## Cross Sectional Statistics

# Stats will be generated across groups (i.e. Cohort) using the gp_stat_sum function

# Statistics are performed on cohorts at different time points

inf_stats_co <- gp_stat_sum(data=met_lmer_data,            #Data set specified
                            sub_vars="DisplayWeek",      #Subset variable for stratification is selected
                            dep_vars=inf_vars,    #Dependent variables are the inf_vars previously defined
                            gp_var="Cohort",      #Group variable is cohort
                            normality= FALSE,     #Data has not been normalized so we are doing nonparametric tests
                            adj="bonferroni"      #p-value adjustment method is Bonferroni
                            )  
```


#### Longitudinal Changes
```{r}


## Longitduinal Statistics

# Stats will be generated for longitudinal changes using the long_stat_sum function



inf_stats_long <- long_stat_sum(data=met_lmer_data,                   #Data set specified
                                sub_vars="Cohort",           #Subset variable for stratification is selected#
                                tm_var="DisplayWeek",               #The time variable is elected
                                dep_vars=inf_vars,           #Dependent variables are the inf_vars previously defined 
                                rand_var="PID",              #Random variable (patient ID) is selected
                                normality=FALSE,             #Data has not been normalized so we are doing nonparametric tests
                                adj="bonferroni",            #p-value adjustment method is Bonferroni
                                pw="separate")  #pairwise comparisons are a wilcoxon


#Manual correction because it does so by group
inf_stats_long$padj[which(inf_stats_long$Cohort=="Naïve")] <- p.adjust(inf_stats_long$`p-value`[which(inf_stats_long$Cohort=="Naïve")], method="fdr")
inf_stats_long$padj[which(inf_stats_long$Cohort=="Exp")] <- p.adjust(inf_stats_long$`p-value`[which(inf_stats_long$Cohort=="Exp")], method="fdr")
inf_stats_long$padj[which(inf_stats_long$Cohort=="HC")] <- p.adjust(inf_stats_long$`p-value`[which(inf_stats_long$Cohort=="Exp")], method="fdr") 
inf_stats_long$p.signif <- add_asterisks(inf_stats_long$padj)   

#We pull out the variables that change in the ART naive group
delta_inf_vars <- inf_stats_long$Measure[which(inf_stats_long$Cohort=="Naïve" & inf_stats_long$padj<0.05)]
saveRDS(delta_inf_vars, file = "../../Data/R_Data/delta_inf_vars.RDS")

#We specify the factors for the weeks and cohort to coicide with the plot
inf_stats_long$group1 <- factor(inf_stats_long$group1, levels=c("0 Weeks", "24 Weeks"), ordered=TRUE)
inf_stats_long$group2 <- factor(inf_stats_long$group2, levels=c("0 Weeks", "24 Weeks"), ordered=TRUE)

inf_stats_long$Cohort <- factor(inf_stats_long$Cohort, levels=c("Naïve", "Exp", "HC"), ordered=TRUE)


```


#### Violin plot
```{r}

# First I use them same color scheme as described in Zim1 
cohortColors <- palette(brewer.pal(n = 5, name = "BrBG"))
cohortColors <- palette(brewer.pal(n = 5, name = "BrBG")) #Repeated to solidify? 
visitColors <- palette(brewer.pal(n = 5, name = "PiYG")) 
visitColors <- palette(brewer.pal(n = 5, name = "PiYG")) #repeat to solidify


#We pull out the naive stats for IL-6
inf_stats_long_naive_IL6 <- inf_stats_long[which(inf_stats_long$Cohort=="Naïve"),]

#INf long
met_lmer_data_inf_long <- pivot_longer(data=met_lmer_data,
                                       cols=inf_vars,
                                       values_to="Amount",
                                       names_to="Measure")
                                       
                                       

#Displat week needs to be generated 
met_lmer_data_inf_long$DisplayWeek <- factor(met_lmer_data_inf_long$DisplayWeek, levels=c("0 Weeks", "24 Weeks"))

inf_viol <- ggplot(data=met_lmer_data_inf_long, aes(x=DisplayWeek, y=Amount, fill=DisplayWeek))+
                      geom_violin() +
  geom_line(mapping = aes(group = PID),
            position = position_dodge(0.1),
            alpha = .3,
            size=.5) +
  geom_point(mapping = aes(fill=DisplayWeek,group = PID),
             size = 2,
             shape=21,
             position = position_dodge(0.1)) +
  scale_fill_manual(values=c(visitColors[1],visitColors[5]))+
  labs(y="Inflammatory Measure", tag="A")+
  theme_classic() +
  theme(legend.position = "none",
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 20),
        axis.text.x = element_text(size = 15, hjust=1, angle=45),
        axis.title.y = element_text(size = 20),
        axis.title.x = element_blank(),
        axis.text.y = element_text(size = 15),
        strip.text.x = element_text(size=12),
        strip.text.y = element_text(size=15),
        plot.tag = element_text(size=25),
        ggh4x.facet.nestline = element_blank(),
        strip.background.x = element_rect(
          color="black", fill="gray", linetype="solid"
        ),
        strip.background.y = element_rect(
          color="black", fill="gray", linetype="solid"
        )) +
  stat_pvalue_manual(
    inf_stats_long_naive_IL6,
    label = "p.signif",
    hide.ns = TRUE,
    y.position = 25
  ) +
  facet_nested(rows=vars(Measure),
               scales="free",
               independent=TRUE)



```



#### Linear Mixed Effects Models  - All Participants

```{r}



#We generate an linear mixed effects model data set to inlcude results
inf_lm_data <- unique(expand.grid(inf_vars, met_vars))

colnames(inf_lm_data) <- c("Predictor","Outcome")
#We generate fields for the statistics
inf_lm_data["pval"] <- NA
inf_lm_data["padj"] <- NA
inf_lm_data["coef"] <- NA
inf_lm_data["sig"] <- NA
inf_lm_data["percent_variance_exp"] <- NA

for (response in met_vars) { 
  #We pull the confounders for that variable
  conf_r <- get(paste0("conf_vars_",response))
  
  #We add them to the inf_vars
  inf_vars_full <- c(inf_vars,conf_r)

  #We remove missing variables
  data_r <- na.omit(met_lmer_data[,c(response,inf_vars_full,"PID")])
    
  # create full model 
  ff <- as.formula(paste0(response,"~",paste0(inf_vars_full, collapse="+"),"+(1|PID)")) 
  fm <- lmer(ff,
             data = data_r)
  
  predict_fm <- predict(fm)
  sum_fm <- summary(fm)
  
  #Below we calculate the R -suared value
  #First total sum of squares
    tss <- sum((unlist(data_r[,c(response)])-mean(unlist(data_r[,c(response)])))^2)
    #Second residual sum of squares
    rss <- sum((unlist(data_r[,c(response)])-predict_fm)^2)
  #R-squared
  r_squared <- 1-(rss/tss)
  #Percent variance explained
  pve <- r_squared*100
  
  inf_lm_data$percent_variance_exp[which(inf_lm_data$Outcome==response)] <- pve
  class(pve) <- "numeric"
  
  #We pull out the coefficinets
  coef_fm <- as.data.frame(sum_fm$coefficients)
  coef_fm$padj <- p.adjust(coef_fm$`Pr(>|t|)`, method="fdr")
  
  #Now we go through each predictor and pull out the coefficient in p-value 
  for (pred in inf_vars) {
    #We pull the row in the coefficient data set (use substr because sometime strings are added)
    coef_row <- which(substr(rownames(coef_fm),1,nchar(pred))==pred)
    #We not pull the row from the lm data set to put it in
    stat_row <- which(as.character(inf_lm_data$Predictor)==pred & as.character(inf_lm_data$Outcome)==response)
    #We add an if statemenbt to make sure we only add values when its ad 
    
    if (length(coef_row)==1 & length(stat_row)==1) {
      #We pull out the p-valueand adjusted p-value
      inf_lm_data$pval[stat_row] <- coef_fm$`Pr(>|t|)`[coef_row]
      inf_lm_data$padj[stat_row] <- coef_fm$padj[coef_row]
      #We pull out the coefficient
      inf_lm_data$coef[stat_row] <- coef_fm$Estimate[coef_row]
      
      #Based on the direction we indicate if it is positive of negative
      if (inf_lm_data$coef[stat_row]>0) {
        inf_lm_data$sig[stat_row] <- "Positive"
      } 
      if (inf_lm_data$coef[stat_row]<0) {
        inf_lm_data$sig[stat_row] <- "Negative"
      } 
      if (inf_lm_data$padj[stat_row]<0.05) {
        inf_lm_data$sig[stat_row] <- paste0(inf_lm_data$sig[stat_row], " (Significant)")
      }
      
      
      
    }
  }
  
  
}


#We add -C to the LDL and HDL for visualization
inf_lm_data$DisplayOutcome <- gsub("DL","DL-C",inf_lm_data$Outcome)
#We replace the trig abbreviation with the full Triglycerides name 
inf_lm_data$DisplayOutcome <- gsub("Trig","Triglycerides",inf_lm_data$DisplayOutcome)
#Now we add the percent variance explained
inf_lm_data$DisplayOutcome <- paste0(inf_lm_data$DisplayOutcome, " (",round(inf_lm_data$percent_variance_exp,1),"% exp)")


inf_plot <- ggplot(inf_lm_data, aes(x = Predictor, y = DisplayOutcome, color=sig)) +
  scale_color_manual(values=c("lightblue","blue","pink","red"))+
  geom_point(size=5) +
  theme_minimal() +
  labs(x = "Plasma Measure", y = " ", fill=" ", tag="B", title="All Participants") +
  theme_classic() +
  guides(color = guide_legend(ncol = 1))+
  theme(legend.position = "right",
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        axis.text.y = element_text(size=12),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 12, angle=45, hjust=1),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        title = element_text(size=20),
        plot.tag = element_text(size=25))


```

#### Linear Mixed Effects Models  - Naive Participants
```{r}

#We filter the met_lmer_data set to only include naive partiapants

met_lmer_data_naive <- met_lmer_data[which(met_lmer_data$Cohort=="Naïve"),]

#We generate an linear mixed effects model data set to inlcude results
inf_lm_data_naive <- unique(expand.grid(inf_vars, met_vars))

colnames(inf_lm_data_naive) <- c("Predictor","Outcome")
#We generate fields for the statistics
inf_lm_data_naive["pval"] <- NA
inf_lm_data_naive["padj"] <- NA
inf_lm_data_naive["coef"] <- NA
inf_lm_data_naive["sig"] <- NA
inf_lm_data_naive["percent_variance_exp"] <- NA

for (response in met_vars) { 
  #We pull the confounders for that variable
  conf_r <- get(paste0("conf_vars_",response))
  
  #We add them to the inf_vars
  #Because they are all HIV positive (HIV should be removed if in there)
  
  inf_vars_full <- setdiff(c(inf_vars,conf_r),"HIV_Status")

  #We remove missing variables
  data_r <- na.omit(met_lmer_data_naive[,c(response,inf_vars_full,"PID")])
  
  # create full model 
  ff <- as.formula(paste0(response,"~",paste0(inf_vars_full, collapse="+"),"+(1|PID)")) 
  fm <- lmer(ff,
             data = data_r)
  
  predict_fm <- predict(fm)
  sum_fm <- summary(fm)
  
  #Below we calculate the R -suared value
  #First total sum of squares
    tss <- sum((unlist(data_r[,c(response)])-mean(unlist(data_r[,c(response)])))^2)
    #Second residual sum of squares
    rss <- sum((unlist(data_r[,c(response)])-predict_fm)^2)
  #R-squared
  r_squared <- 1-(rss/tss)
  #Percent variance explained
  pve <- r_squared*100
  
  inf_lm_data_naive$percent_variance_exp[which(inf_lm_data_naive$Outcome==response)] <- pve
  class(pve) <- "numeric"
  
  #We pull out the coefficinets
  coef_fm <- as.data.frame(sum_fm$coefficients)
  coef_fm$padj <- p.adjust(coef_fm$`Pr(>|t|)`, method="fdr")
  
  #Now we go through each predictor and pull out the coefficient in p-value 
  for (pred in inf_vars) {

    #We pull the row in the coefficient data set (use substr because sometime strings are added)
    coef_row <- which(substr(rownames(coef_fm),1,nchar(pred))==pred)
    #We not pull the row from the lm data set to put it in
    stat_row <- which(as.character(inf_lm_data_naive$Predictor)==pred & as.character(inf_lm_data_naive$Outcome)==response)
    #We add an if statemenbt to make sure we only add values when its ad 
    
    if (length(coef_row)==1 & length(stat_row)==1) {
      #We pull out the p-valueand adjusted p-value
      inf_lm_data_naive$pval[stat_row] <- coef_fm$`Pr(>|t|)`[coef_row]
      inf_lm_data_naive$padj[stat_row] <- coef_fm$padj[coef_row]
      #We pull out the coefficient
      inf_lm_data_naive$coef[stat_row] <- coef_fm$Estimate[coef_row]
      
      #Based on the direction we indicate if it is positive of negative
      if (inf_lm_data_naive$coef[stat_row]>0) {
        inf_lm_data_naive$sig[stat_row] <- "Positive"
      } 
      if (inf_lm_data_naive$coef[stat_row]<0) {
        inf_lm_data_naive$sig[stat_row] <- "Negative"
      } 
      if (inf_lm_data_naive$padj[stat_row]<0.05) {
        inf_lm_data_naive$sig[stat_row] <- paste0(inf_lm_data_naive$sig[stat_row], " (Significant)")
      }
      
      
      
    }
  }
  
  
}


#We add -C to the LDL and HDL for visualization
inf_lm_data_naive$DisplayOutcome <- gsub("DL","DL-C",inf_lm_data_naive$Outcome)
#We replace the trig abbreviation with the full Triglycerides name 
inf_lm_data_naive$DisplayOutcome <- gsub("Trig","Triglycerides",inf_lm_data_naive$DisplayOutcome)
#Now we add the percent variance explained
inf_lm_data_naive$DisplayOutcome <- paste0(inf_lm_data_naive$DisplayOutcome, " (",round(inf_lm_data_naive$percent_variance_exp,1),"% exp)")


inf_plot_naive <- ggplot(inf_lm_data_naive, aes(x = Predictor, y = DisplayOutcome, color=sig)) +
  scale_color_manual(values=c("lightblue","blue","pink","red"))+
  geom_point(size=5) +
  theme_minimal() +
  labs(x = "Plasma Measure", y = " ", fill=" ", tag="C", title="Naïve Participants") +
  theme_classic() +
  guides(color = guide_legend(ncol = 1))+
  theme(legend.position = "right",
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        axis.text.y = element_text(size=12),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 12, angle=45, hjust=1),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        title = element_text(size=20),
        plot.tag = element_text(size=25))


```


#### IL-6 Mediation DAG
```{r}



# Nodes are created in a data frame
nodes_IL6 <- data.frame(
  label = c("ART and\nCotrimoxazole\nTreatment", "Decreased\nIL-6", "Increased\nHDL-C"),
  x = c(1, 2, 3),
  y = c(1, 2, 1),
  category=c("Predictor","Mediator","Outcome")
)

# Original arrow coordinates
arrows_IL6 <- data.frame(
  x1 = c(1, 1, 2),
  y1 = c(1, 1, 2),
  x2 = c(2, 3, 3),
  y2 = c(2, 1, 1)
)

# Calculate new coordinates for the arrows

arrows_IL6_adjusted <- arrows_IL6
for (i in 1:nrow(arrows_IL6)) {
  x_diff <- arrows_IL6$x2[i] - arrows_IL6$x1[i]
  y_diff <- arrows_IL6$y2[i] - arrows_IL6$y1[i]
  length_orig <- sqrt(x_diff^2 + y_diff^2)
  if (length_orig > 0) {
    arrows_IL6_adjusted$x2[i] <- arrows_IL6$x1[i] + x_diff * ((length_orig - (length_orig/2)) / length_orig)
    arrows_IL6_adjusted$y2[i] <- arrows_IL6$y1[i] + y_diff * ((length_orig - (length_orig/2)) / length_orig)
  }
}

# Arrow Labels are created in a data frame
arrow_labels_IL6 <- data.frame(
  x = c(1.3, 2, 2.7),
  y = c(1.6, 1.1, 1.6),
  label = c("-2.44(**)","15.96***(13.3***)","-1.44***")
)

# The DAG is made in GGplot with adjusted arrows
IL6_med_dag <- ggplot() +
  geom_segment(data = arrows_IL6_adjusted,  # Use the adjusted coordinates
               aes(x = x1, y = y1, xend = x2, yend = y2),
               arrow = arrow(length = unit(0.3, "cm"), type = "closed")) +
  geom_segment(data = arrows_IL6,  # Use the adjusted coordinates
               aes(x = x1, y = y1, xend = x2, yend = y2),
               arrow = arrow(length = unit(0.3, "cm"), type = "closed")) +
  geom_text(data = arrow_labels_IL6, aes(x = x, y = y, label = label), size = 4) +
  geom_label(data = nodes_IL6, 
             aes(x = x, y = y, label = label, fill = category), 
             size = 5, 
             key_glyph = "rect") +
  scale_fill_manual(values = c("orange", "lightgreen", "lightblue")) +
  scale_x_continuous(limits = c(0.5, 3.5)) +
  scale_y_continuous(limits = c(0.5, 2.5)) +
  theme_void() +
  labs(title = "Mediation Results", 
       tag = "D", 
       fill = " ") +
  theme(legend.position = "right",
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 20),
        plot.tag = element_text(size = 25),
        title = element_text(size = 20))



```

####Plot Saving
```{r}

#Supplementary Figure 2 is the IL-6 violin plot (Fig 1SA) as well as results of the linear mixed effects models in all participnats (Fig 1SB) and naive participnats (Fig 1SC)

saveRDS(inf_viol, file = "../../Figures/Panels/FIGS2A.RDS")
saveRDS(inf_plot, file = "../../Figures/Panels/FIGS2B.RDS")
saveRDS(inf_plot_naive, file = "../../Figures/Panels/FIGS2C.RDS")
saveRDS(IL6_med_dag, file = "../../Figures/Panels/FIGS2D.RDS")


```


### Immune Measures

####Cross Sectional Differences
```{r}


#Immune cell populations are defined
imm_vars <- c("CD14_Classical_Monocytes_Percent", #CD14+ Classical mMnocytes
                  "CD14_Classical_HLADR_Percent", #CD14+ HLA-DR+ Classical Monocytes
                  "CD14_Classical_PD1_Percent", #CD14+ PD-1+ Classical Monocytes
                  "CD14_Intermediate_Monocytes_Percent", #CD14+ Intermediate Monocytes
                  "CD14_Intermediate_HLADR_Percent", #CD14+ HLA-DR+ Intermediate Monocytes
                  "CD14_Intermediate_PD1_Percent", #CD14+ PD-1+ Intermediate Monocytes
                  "CD3_Percent", #T Cells
                  "CD4_Percent", #CD4+ T Cells
                  "CD4_CD103_Percent", #CD4+ CD103+ T Cells
                  "CD4_PD1_Percent", #CD4+ PD-1+ T Cells
                  "CD4_HLADRpos_CD38pos_Percent", #CD4+ HLA-DR+ CD38+ T Cells
                  "CD8_Percent", #CD8+ T Cells
                  "CD8_CD103_Percent",#CD8+ CD103+ T Cells
                  "CD8_PD1_Percent", #CD8+ PD-1+ T Cells
                  "CD8_HLADRpos_CD38pos_Percent") #CD8+ HLA-DR+ CD38+ T Cells



## Cross Sectional Statistics

# Stats will be generated across groups (i.e. Cohort) using the gp_stat_sum function

# Statistics are performed on cohorts at different time points

inf_stats_co <- gp_stat_sum(data=met_lmer_data,            #Data set specified
                            sub_vars="DisplayWeek",      #Subset variable for stratification is selected
                            dep_vars=imm_vars,    #Dependent variables are the imm_vars previously defined
                            gp_var="Cohort",      #Group variable is cohort
                            normality= FALSE,     #Data has not been normalized so we are doing nonparametric tests
                            adj="bonferroni"      #p-value adjustment method is Bonferroni
                            )  

```

####Longitudinal Changes
```{r}


## Longitduinal Statistics

#Wilcoxon ("Separate)

# Stats will be generated for longitudinal changes using the long_stat_sum function



imm_stats_long <- long_stat_sum(data=met_lmer_data,                   #Data set specified
                                sub_vars="Cohort",           #Subset variable for stratification is selected#
                                tm_var="DisplayWeek",               #The time variable is elected
                                dep_vars=imm_vars,           #Dependent variables are the imm_vars previously defined 
                                rand_var="PID",              #Random variable (patient ID) is selected
                                normality=FALSE,             #Data has not been normalized so we are doing nonparametric tests
                                adj="bonferroni",            #p-value adjustment method is Bonferroni
                                pw="separate") #pairwise comparisons are a wilcoxon



#Manual correction because it does so by group
imm_stats_long$padj[which(imm_stats_long$Cohort=="Naïve")] <- p.adjust(imm_stats_long$`p-value`[which(imm_stats_long$Cohort=="Naïve")], method="fdr")
imm_stats_long$padj[which(imm_stats_long$Cohort=="Exp")] <- p.adjust(imm_stats_long$`p-value`[which(imm_stats_long$Cohort=="Exp")], method="fdr")
imm_stats_long$padj[which(imm_stats_long$Cohort=="HC")] <- p.adjust(imm_stats_long$`p-value`[which(imm_stats_long$Cohort=="HC")], method="fdr")
imm_stats_long$p.signif <- add_asterisks(imm_stats_long$padj)                                                     

#We pull out the variables that change in the ART naive group
delta_imm_vars <- imm_stats_long$Measure[which(imm_stats_long$Cohort=="Naïve" & imm_stats_long$padj<0.05)]
saveRDS(delta_imm_vars, file = "../../Data/R_Data/delta_imm_vars.RDS")  

####Friedman Test ("same")
#We specify the factors for the weeks and cohort to coicide with the plot
imm_stats_long$group1 <- factor(imm_stats_long$group1, levels=c("0 Weeks", "24 Weeks"), ordered=TRUE)
imm_stats_long$group2 <- factor(imm_stats_long$group2, levels=c("0 Weeks", "24 Weeks"), ordered=TRUE)

imm_stats_long$Cohort <- factor(imm_stats_long$Cohort, levels=c("Naïve", "Exp", "HC"), ordered=TRUE)


imm_stats_long_same <- long_stat_sum(data=met_lmer_data,                   #Data set specified
                                sub_vars="Cohort",           #Subset variable for stratification is selected#
                                tm_var="DisplayWeek",               #The time variable is elected
                                dep_vars=imm_vars,           #Dependent variables are the imm_vars previously defined 
                                rand_var="PID",              #Random variable (patient ID) is selected
                                normality=FALSE,             #Data has not been normalized so we are doing nonparametric tests
                                adj="bonferroni",            #p-value adjustment method is Bonferroni
                                pw="same") #pairwise comparisons are a wilcoxon



#Manual correction because it does so by group
imm_stats_long_same$padj[which(imm_stats_long_same$Cohort=="Naïve")] <- p.adjust(imm_stats_long_same$`p-value`[which(imm_stats_long_same$Cohort=="Naïve")], method="fdr")
imm_stats_long_same$padj[which(imm_stats_long_same$Cohort=="Exp")] <- p.adjust(imm_stats_long_same$`p-value`[which(imm_stats_long_same$Cohort=="Exp")], method="fdr")
imm_stats_long_same$padj[which(imm_stats_long_same$Cohort=="HC")] <- p.adjust(imm_stats_long_same$`p-value`[which(imm_stats_long_same$Cohort=="HC")], method="fdr")
imm_stats_long_same$p.signif <- add_asterisks(imm_stats_long_same$padj)                                                     

#We specify the factors for the weeks and cohort to coicide with the plot
imm_stats_long_same$group1 <- factor(imm_stats_long_same$group1, levels=c("0 Weeks", "24 Weeks"), ordered=TRUE)
imm_stats_long_same$group2 <- factor(imm_stats_long_same$group2, levels=c("0 Weeks", "24 Weeks"), ordered=TRUE)

imm_stats_long_same$Cohort <- factor(imm_stats_long_same$Cohort, levels=c("Naïve", "Exp", "HC"), ordered=TRUE)





```

####Violin Plot
```{r}

#We filter the significant stats in the naive group
imm_stats_long_select <- imm_stats_long[which(imm_stats_long$padj<0.05 & imm_stats_long$Cohort=="Naïve"),]

#For ggplot to recognize the stats you need a field for the x-value (should debug this)
imm_stats_long_select$DisplayWeek <- imm_stats_long_select$group1

#We pivot to a long format for the plot
imm_base_long <- pivot_longer(met_lmer_data,
                              cols=imm_vars,
                              values_to="Total",
                              names_to="Measure")

#Now we filter to include the select cell populations that were significnat in the naive group
imm_base_long_select <- imm_base_long[which(imm_base_long$Measure %in% imm_stats_long_select$Measure & imm_base_long$Cohort %in% imm_stats_long_select$Cohort),]

#The cell population names are adjusted for th figure to be more intuitive
imm_stats_long_select$DisplayMeasure <- imm_stats_long_select$Measure
imm_stats_long_select$DisplayMeasure <- gsub("CD14_","CD14+",imm_stats_long_select$DisplayMeasure)
imm_stats_long_select$DisplayMeasure <- gsub("CD4_","CD4+",imm_stats_long_select$DisplayMeasure)
imm_stats_long_select$DisplayMeasure <- gsub("mediate_","mediate\n",imm_stats_long_select$DisplayMeasure)
imm_stats_long_select$DisplayMeasure <- gsub("Inter","\nInter",imm_stats_long_select$DisplayMeasure)
imm_stats_long_select$DisplayMeasure <- gsub("CD8_","CD8+",imm_stats_long_select$DisplayMeasure)
imm_stats_long_select$DisplayMeasure <- gsub("CD3_","CD3+",imm_stats_long_select$DisplayMeasure)
imm_stats_long_select$DisplayMeasure <- gsub("neg","-",imm_stats_long_select$DisplayMeasure)
imm_stats_long_select$DisplayMeasure <- gsub("pos","+",imm_stats_long_select$DisplayMeasure)
imm_stats_long_select$DisplayMeasure <- gsub("_Percent","(%)",imm_stats_long_select$DisplayMeasure)
imm_stats_long_select$DisplayMeasure <- gsub("_PD1","PD-1+",imm_stats_long_select$DisplayMeasure)
imm_stats_long_select$DisplayMeasure <- gsub("Percent","(%)",imm_stats_long_select$DisplayMeasure)
imm_stats_long_select$DisplayMeasure <- gsub("_HLADR","HLADR+",imm_stats_long_select$DisplayMeasure)
imm_stats_long_select$DisplayMeasure <- gsub("_CD38","CD38",imm_stats_long_select$DisplayMeasure)
imm_stats_long_select$DisplayMeasure <- gsub("PD1","PD-1+",imm_stats_long_select$DisplayMeasure)
imm_stats_long_select$DisplayMeasure <- gsub("CD103","CD103+",imm_stats_long_select$DisplayMeasure)
imm_stats_long_select$DisplayMeasure <- substr(imm_stats_long_select$DisplayMeasure,1,nchar(imm_stats_long_select$DisplayMeasure)-3)
imm_stats_long_select$DisplayMeasure <- gsub("HLADR+","HLADR+\n",imm_stats_long_select$DisplayMeasure)
imm_stats_long_select$DisplayMeasure[which(substr(imm_stats_long_select$DisplayMeasure,1,4)!="CD14")] <- paste0(imm_stats_long_select$DisplayMeasure[which(substr(imm_stats_long_select$DisplayMeasure,1,4)!="CD14")], "\nT Cells")
imm_stats_long_select$DisplayMeasure[which(imm_stats_long_select$DisplayMeasure=="CD8+HLADR+\n+CD38+\nT Cells")]<- "CD8+HLADR+\nCD38+ T Cells"




imm_base_long_select$DisplayMeasure <- imm_base_long_select$Measure
imm_base_long_select$DisplayMeasure <- gsub("CD14_","CD14+",imm_base_long_select$DisplayMeasure)
imm_base_long_select$DisplayMeasure <- gsub("mediate_","mediate\n",imm_base_long_select$DisplayMeasure)
imm_base_long_select$DisplayMeasure <- gsub("Inter","\nInter",imm_base_long_select$DisplayMeasure)
imm_base_long_select$DisplayMeasure <- gsub("CD4_","CD4+",imm_base_long_select$DisplayMeasure)
imm_base_long_select$DisplayMeasure <- gsub("CD8_","CD8+",imm_base_long_select$DisplayMeasure)
imm_base_long_select$DisplayMeasure <- gsub("CD3_","CD3+",imm_base_long_select$DisplayMeasure)
imm_base_long_select$DisplayMeasure <- gsub("neg","-",imm_base_long_select$DisplayMeasure)
imm_base_long_select$DisplayMeasure <- gsub("pos","+",imm_base_long_select$DisplayMeasure)
imm_base_long_select$DisplayMeasure <- gsub("_Percent","(%)",imm_base_long_select$DisplayMeasure)
imm_base_long_select$DisplayMeasure <- gsub("_PD1","PD-1+",imm_base_long_select$DisplayMeasure)
imm_base_long_select$DisplayMeasure <- gsub("Percent","(%)",imm_base_long_select$DisplayMeasure)
imm_base_long_select$DisplayMeasure <- gsub("_HLADR","HLADR+",imm_base_long_select$DisplayMeasure)
imm_base_long_select$DisplayMeasure <- gsub("_CD38","CD38",imm_base_long_select$DisplayMeasure)
imm_base_long_select$DisplayMeasure <- gsub("PD1","PD-1+",imm_base_long_select$DisplayMeasure)
imm_base_long_select$DisplayMeasure <- gsub("CD103","CD103+",imm_base_long_select$DisplayMeasure)
imm_base_long_select$DisplayMeasure <- substr(imm_base_long_select$DisplayMeasure,1,nchar(imm_base_long_select$DisplayMeasure)-3)
imm_base_long_select$DisplayMeasure <- gsub("HLADR+","HLADR+\n",imm_base_long_select$DisplayMeasure)
imm_base_long_select$DisplayMeasure[which(substr(imm_base_long_select$DisplayMeasure,1,4)!="CD14")] <- paste0(imm_base_long_select$DisplayMeasure[which(substr(imm_base_long_select$DisplayMeasure,1,4)!="CD14")], "\nT Cells")
imm_base_long_select$DisplayMeasure[which(imm_base_long_select$DisplayMeasure=="CD8+HLADR+\n+CD38+\nT Cells")]<- "CD8+HLADR+\nCD38+ T Cells"


imm_base_long_select$DisplayWeek <- factor(imm_base_long_select$DisplayWeek, levels=c("0 Weeks", "24 Weeks"))

imm_select_viol <- ggplot(data=imm_base_long_select, aes(x=DisplayWeek, y=Total, fill=DisplayWeek))+
  geom_violin() +
  geom_line(mapping = aes(group = PID),
            position = position_dodge(0.1),
            alpha = .3,
            size=.5) +
  geom_point(mapping = aes(fill=DisplayWeek,group = PID),
             size = 2,
             shape=21,
             position = position_dodge(0.1)) +
  scale_fill_manual(values=c(visitColors[1],visitColors[5]))+
  labs(y="Percent of Parent", tag="A")+
  theme_classic() +
  theme(legend.position = "none",
        legend.title = element_text(size = 20),
        legend.text = element_text(size = 20),
        axis.text.x = element_text(size = 15, hjust=1, angle=45),
        axis.title.y = element_text(size = 20),
        axis.title.x = element_blank(),
        axis.text.y = element_text(size = 15),
        strip.text.x = element_text(size=12),
        strip.text.y = element_text(size=15),
        plot.tag = element_text(size=25),
        ggh4x.facet.nestline = element_blank(),
        strip.background.x = element_rect(
          color="black", fill="gray", linetype="solid"
        ),
        strip.background.y = element_rect(
          color="black", fill="gray", linetype="solid"
        )) +
  stat_pvalue_manual(
    imm_stats_long_select,
    label = "p.signif",
    hide.ns = TRUE,
    y.position = c(50,75,40,110,100,52,100,100)
  ) + 
  facet_wrap(~DisplayMeasure, nrow=2, scales="free")





```



#### Linear Mixed Effects Models  - All Participants

```{r}



#We generate an linear mixed effects model data set to inlcude results
imm_lm_data <- unique(expand.grid(imm_vars, met_vars))

colnames(imm_lm_data) <- c("Predictor","Outcome")
#We generate fields for the statistics
imm_lm_data["pval"] <- NA
imm_lm_data["padj"] <- NA
imm_lm_data["coef"] <- NA
imm_lm_data["sig"] <- NA
imm_lm_data["percent_variance_exp"] <- NA

for (response in met_vars) { 
  #We pull the confounders for that variable
  conf_r <- get(paste0("conf_vars_",response))
  
  #We add them to the imm_vars
  imm_vars_full <- c(imm_vars,conf_r)
  
  #We remove missing variables
  data_r <- na.omit(met_lmer_data[,c(response,imm_vars_full,"PID")])
  
  # create full model 
  ff <- as.formula(paste0(response,"~",paste0(imm_vars_full, collapse="+"),"+(1|PID)")) 
  fm <- lmer(ff,
             data = data_r)
  
  predict_fm <- predict(fm)
  sum_fm <- summary(fm)
  
  #Below we calculate the R -suared value
  #First total sum of squares
    tss <- sum((unlist(data_r[,c(response)])-mean(unlist(data_r[,c(response)])))^2)
    #Second residual sum of squares
    rss <- sum((unlist(data_r[,c(response)])-predict_fm)^2)
  #R-squared
  r_squared <- 1-(rss/tss)
  #Percent variance explained
  pve <- r_squared*100
  
  imm_lm_data$percent_variance_exp[which(imm_lm_data$Outcome==response)] <- pve
  class(pve) <- "numeric"
  
  #We pull out the coefficinets
  coef_fm <- as.data.frame(sum_fm$coefficients)
  coef_fm$padj <- p.adjust(coef_fm$`Pr(>|t|)`, method="fdr")
  
  #Now we go through each predictor and pull out the coefficient in p-value 
  for (pred in imm_vars) {
    #We pull the row in the coefficient data set (use substr because sometime strings are added)
    coef_row <- which(substr(rownames(coef_fm),1,nchar(pred))==pred)
    #We not pull the row from the lm data set to put it in
    stat_row <- which(as.character(imm_lm_data$Predictor)==pred & as.character(imm_lm_data$Outcome)==response)
    #We add an if statemenbt to make sure we only add values when its ad 
    
    if (length(coef_row)==1 & length(stat_row)==1) {
      #We pull out the p-valueand adjusted p-value
      imm_lm_data$pval[stat_row] <- coef_fm$`Pr(>|t|)`[coef_row]
      imm_lm_data$padj[stat_row] <- coef_fm$padj[coef_row]
      #We pull out the coefficient
      imm_lm_data$coef[stat_row] <- coef_fm$Estimate[coef_row]
      
      #Based on the direction we indicate if it is positive of negative
      if (imm_lm_data$coef[stat_row]>0) {
        imm_lm_data$sig[stat_row] <- "Positive"
      } 
      if (imm_lm_data$coef[stat_row]<0) {
        imm_lm_data$sig[stat_row] <- "Negative"
      } 
      if (imm_lm_data$padj[stat_row]<0.05) {
        imm_lm_data$sig[stat_row] <- paste0(imm_lm_data$sig[stat_row], " (Significant)")
      }
      
      
      
    }
  }
  
  
}


#We add -C to the LDL and HDL for visualization
imm_lm_data$DisplayOutcome <- gsub("DL","DL-C",imm_lm_data$Outcome)
#We replace the trig abbreviation with the full Triglycerides name 
imm_lm_data$DisplayOutcome <- gsub("Trig","Triglycerides",imm_lm_data$DisplayOutcome)
#Now we add the percent variance explained
imm_lm_data$DisplayOutcome <- paste0(imm_lm_data$DisplayOutcome, " (",round(imm_lm_data$percent_variance_exp,1),"% exp)")



imm_lm_data$DisplayPredictor <- imm_lm_data$Predictor
imm_lm_data$DisplayPredictor <- gsub("CD14_","CD14+",imm_lm_data$DisplayPredictor)
imm_lm_data$DisplayPredictor <- gsub("mediate_","mediate",imm_lm_data$DisplayPredictor)
imm_lm_data$DisplayPredictor <- gsub("CD4_","CD4+",imm_lm_data$DisplayPredictor)
imm_lm_data$DisplayPredictor <- gsub("CD8_","CD8+",imm_lm_data$DisplayPredictor)
imm_lm_data$DisplayPredictor <- gsub("CD3_","CD3+",imm_lm_data$DisplayPredictor)
imm_lm_data$DisplayPredictor <- gsub("neg","-",imm_lm_data$DisplayPredictor)
imm_lm_data$DisplayPredictor <- gsub("pos","+",imm_lm_data$DisplayPredictor)
imm_lm_data$DisplayPredictor <- gsub("_Percent","(%)",imm_lm_data$DisplayPredictor)
imm_lm_data$DisplayPredictor <- gsub("_PD1","PD-1+",imm_lm_data$DisplayPredictor)
imm_lm_data$DisplayPredictor <- gsub("Percent","(%)",imm_lm_data$DisplayPredictor)
imm_lm_data$DisplayPredictor <- gsub("_HLADR","HLADR+",imm_lm_data$DisplayPredictor)
imm_lm_data$DisplayPredictor <- gsub("_CD38","CD38",imm_lm_data$DisplayPredictor)
imm_lm_data$DisplayPredictor <- gsub("PD1","PD-1+",imm_lm_data$DisplayPredictor)
imm_lm_data$DisplayPredictor <- gsub("CD103","CD103+",imm_lm_data$DisplayPredictor)
imm_lm_data$DisplayPredictor <- substr(imm_lm_data$DisplayPredictor,1,nchar(imm_lm_data$DisplayPredictor)-3)
imm_lm_data$DisplayPredictor <- gsub("HLADR+","HLADR+",imm_lm_data$DisplayPredictor)
imm_lm_data$DisplayPredictor[which(substr(imm_lm_data$DisplayPredictor,1,4)!="CD14")] <- paste0(imm_lm_data$DisplayPredictor[which(substr(imm_lm_data$DisplayPredictor,1,4)!="CD14")], "T Cells")
imm_lm_data$DisplayPredictor[which(imm_lm_data$DisplayPredictor=="CD8+HLADR++CD38+T Cells")]<- "CD8+HLADR+CD38+ T Cells"
imm_lm_data$DisplayPredictor[which(imm_lm_data$DisplayPredictor=="CD4+HLADR++CD38+T Cells")]<- "CD4+HLADR+CD38+ T Cells"
imm_lm_data$DisplayPredictor[which(imm_lm_data$DisplayPredictor=="CD14+Classical_Monocytes")]<- "CD14+ Classical Monocytes"
imm_lm_data$DisplayPredictor[which(imm_lm_data$DisplayPredictor=="CD14+ClassicalHLADR++")]<- "CD14+HLA-DR+ Classical Monocytes"
imm_lm_data$DisplayPredictor[which(imm_lm_data$DisplayPredictor=="CD14+ClassicalPD-1+")]<- "CD14+PD-1+ Classical Monocytes"
imm_lm_data$DisplayPredictor[which(imm_lm_data$DisplayPredictor=="CD14+IntermediateMonocytes")]<- "CD14+ Intermediate Monocytes" 
imm_lm_data$DisplayPredictor[which(imm_lm_data$DisplayPredictor=="CD14+IntermediateHLADR++")]<- "CD14+HLA-DR+ Intermediate Monocytes"
imm_lm_data$DisplayPredictor[which(imm_lm_data$DisplayPredictor=="CD14+IntermediatePD-1+")]<- "CD14+PD-1+ Intermediate Monocytes"
imm_lm_data$DisplayPredictor[which(imm_lm_data$DisplayPredictor=="CD14+IntermediateHLADR+")]<- "CD14+HLA-DR+ Intermediate Monocytes"





imm_plot <- ggplot(imm_lm_data, aes(x = DisplayPredictor, y = DisplayOutcome, color=sig)) +
  scale_color_manual(values=c("lightblue","blue","pink","red"))+
  geom_point(size=5) +
  theme_minimal() +
  labs(x = "Plasma Measure", y = " ", fill=" ", tag="B", title="All Participants") +
  theme_classic() +
  guides(color = guide_legend(ncol = 1))+
  theme(legend.position = "right",
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        axis.text.y = element_text(size=12),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 12, angle=45, hjust=1),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        title = element_text(size=20),
        plot.tag = element_text(size=25))


```

#### Linear Mixed Effects Models  - Naive Participants
```{r}


#We generate an linear mixed effects model data set to inlcude results
imm_lm_data_naive <- unique(expand.grid(imm_vars, met_vars))

colnames(imm_lm_data_naive) <- c("Predictor","Outcome")
#We generate fields for the statistics
imm_lm_data_naive["pval"] <- NA
imm_lm_data_naive["padj"] <- NA
imm_lm_data_naive["coef"] <- NA
imm_lm_data_naive["sig"] <- NA
imm_lm_data_naive["percent_variance_exp"] <- NA

for (response in met_vars) { 
  #We pull the confounders for that variable
  conf_r <- get(paste0("conf_vars_",response))
  
  #We add them to the imm_vars
  #Because they are all HIV positive (HIV should be removed if in there)
  
  imm_vars_full <- setdiff(c(imm_vars,conf_r),"HIV_Status")
  
  #We remove missing variables
  data_r <- na.omit(met_lmer_data_naive[,c(response,imm_vars_full,"PID")])
  
  # create full model 
  ff <- as.formula(paste0(response,"~",paste0(imm_vars_full, collapse="+"),"+(1|PID)")) 
  fm <- lmer(ff,
             data = data_r)
  
  predict_fm <- predict(fm)
  sum_fm <- summary(fm)
  
  #Below we calculate the R -suared value
  #First total sum of squares
    tss <- sum((unlist(data_r[,c(response)])-mean(unlist(data_r[,c(response)])))^2)
    #Second residual sum of squares
    rss <- sum((unlist(data_r[,c(response)])-predict_fm)^2)
  #R-squared
  r_squared <- 1-(rss/tss)
  #Percent variance explained
  pve <- r_squared*100
  
  imm_lm_data_naive$percent_variance_exp[which(imm_lm_data_naive$Outcome==response)] <- pve
  class(pve) <- "numeric"
  
  #We pull out the coefficinets
  coef_fm <- as.data.frame(sum_fm$coefficients)
  coef_fm$padj <- p.adjust(coef_fm$`Pr(>|t|)`, method="fdr")
  
  #Now we go through each predictor and pull out the coefficient in p-value 
  for (pred in imm_vars) {
    #We pull the row in the coefficient data set (use substr because sometime strings are added)
    coef_row <- which(substr(rownames(coef_fm),1,nchar(pred))==pred)
    #We not pull the row from the lm data set to put it in
    stat_row <- which(as.character(imm_lm_data_naive$Predictor)==pred & as.character(imm_lm_data_naive$Outcome)==response)
    #We add an if statemenbt to make sure we only add values when its ad 
    
    if (length(coef_row)==1 & length(stat_row)==1) {
      #We pull out the p-valueand adjusted p-value
      imm_lm_data_naive$pval[stat_row] <- coef_fm$`Pr(>|t|)`[coef_row]
      imm_lm_data_naive$padj[stat_row] <- coef_fm$padj[coef_row]
      #We pull out the coefficient
      imm_lm_data_naive$coef[stat_row] <- coef_fm$Estimate[coef_row]
      
      #Based on the direction we indicate if it is positive of negative
      if (imm_lm_data_naive$coef[stat_row]>0) {
        imm_lm_data_naive$sig[stat_row] <- "Positive"
      } 
      if (imm_lm_data_naive$coef[stat_row]<0) {
        imm_lm_data_naive$sig[stat_row] <- "Negative"
      } 
      if (imm_lm_data_naive$padj[stat_row]<0.05) {
        imm_lm_data_naive$sig[stat_row] <- paste0(imm_lm_data_naive$sig[stat_row], " (Significant)")
      }
      
      
      
    }
  }
  
  
}


#We add -C to the LDL and HDL for visualization
imm_lm_data_naive$DisplayOutcome <- gsub("DL","DL-C",imm_lm_data_naive$Outcome)
#We replace the trig abbreviation with the full Triglycerides name 
imm_lm_data_naive$DisplayOutcome <- gsub("Trig","Triglycerides",imm_lm_data_naive$DisplayOutcome)
#Now we add the percent variance explained
imm_lm_data_naive$DisplayOutcome <- paste0(imm_lm_data_naive$DisplayOutcome, " (",round(imm_lm_data_naive$percent_variance_exp,1),"% exp)")


imm_plot_naive <- ggplot(imm_lm_data_naive, aes(x = Predictor, y = DisplayOutcome, color=sig)) +
  scale_color_manual(values=c("lightblue","blue","pink","red"))+
  geom_point(size=5) +
  theme_minimal() +
  labs(x = "Plasma Measure", y = " ", fill=" ", tag="F", title="Naïve Participants") +
  theme_classic() +
  guides(color = guide_legend(ncol = 1))+
  theme(legend.position = "right",
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        axis.text.y = element_text(size=12),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 12, angle=45, hjust=1),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        title = element_text(size=20),
        plot.tag = element_text(size=25))


```


#### Monocytes Mediation DAG
```{r}


#This is a manual creation of the IL-6 HDL-C mediation DAG

# Nodes are created in a data frame
nodes_mono <- data.frame(
  label = c("ART and\nCotrimoxazole\nTreatment", "Decreased\nIntermediate\nMonocytes", "Increased\nTriglycerides"),
  x = c(1, 2, 3),
  y = c(1, 2, 1),
  category=c("Predictor","Mediator","Outcome")
)

# Arrows are created in a data frame
arrows_mono <- data.frame(
  x1 = c(1, 1, 2),
  y1 = c(1, 1, 2),
  x2 = c(2, 3, 3),
  y2 = c(2, 1, 1)
)

arrows_mono_adjusted <- arrows_mono
for (i in 1:nrow(arrows_IL6)) {
  x_diff <- arrows_mono$x2[i] - arrows_mono$x1[i]
  y_diff <- arrows_mono$y2[i] - arrows_mono$y1[i]
  length_orig <- sqrt(x_diff^2 + y_diff^2)
  if (length_orig > 0) {
    arrows_mono_adjusted$x2[i] <- arrows_mono$x1[i] + x_diff * ((length_orig - (length_orig/2)) / length_orig)
    arrows_mono_adjusted$y2[i] <- arrows_mono$y1[i] + y_diff * ((length_orig - (length_orig/2)) / length_orig)
  }
}

# Arrow Labels are created in a data frame
arrow_labels_mono <- data.frame(
  x = c(1.3, 2, 2.7),
  y = c(1.6, 1.1, 1.6),
  label = c("-7(***)","14.23(6.84)","-1.19*")
)

#The DAG is made in GGplot
mono_med_dag <- ggplot() +
                geom_segment(data = arrows_mono, 
                           aes(x = x1, y = y1, xend = x2, yend = y2),
                           arrow = arrow(length = unit(0.3, "cm"),type = "closed")) +
                geom_segment(data = arrows_mono_adjusted, 
                           aes(x = x1, y = y1, xend = x2, yend = y2),
                           arrow = arrow(length = unit(0.3, "cm"),type = "closed")) +
                geom_text(data = arrow_labels_mono, aes(x = x, y = y, label = label), size = 4) +
                geom_label(data = nodes_mono, 
                           aes(x = x, y = y, label = label, fill=category), 
                           size = 5, 
                           key_glyph = "rect") +
                scale_fill_manual(values=c("orange","red","lightblue"))+
                scale_x_continuous(limits = c(0.5, 3.5)) +
                scale_y_continuous(limits = c(0.5, 2.5)) +
                theme_void()+
                labs(title="Mediation Results", 
                     tag="C", 
                     fill=" ")+
                theme(legend.position = "right",
                      legend.title = element_text(size = 20),
                      legend.text = element_text(size = 20),
                      plot.tag = element_text(size=25),
                      title = element_text(size=20))
```



#### Immune Cell Ordination


```{r}

#We select just variables with CD and percent avlues
ord_imm_data <- base[,imm_vars]

#We will now imput with zero
for (r in 1:nrow(ord_imm_data)) {
  for (c in 1:ncol(ord_imm_data))
    if (is.na(ord_imm_data[r,c])) {
      ord_imm_data[r,c] <- 0
    }
}


#We generate a euclidean distance matrix
ord_imm_dist <- vegdist(ord_imm_data, method="euclidean", na.rm=TRUE, scale=TRUE)

#We perform an ordination and generate a biplot
ord_imm_res <- prcomp(ord_imm_data)
ord_imm_biplot <- biplot(ord_imm_res, col=c("white","black"))

#We generate a feature distance data set from the rotation output
ord_imm_feature_PCs <- as.data.frame(ord_imm_res$rotation)

#We now add a euclidean distance for each
ord_imm_feature_PCs["Dist"] <- NA
for (r in 1:nrow(ord_imm_feature_PCs)) {
  ord_imm_feature_PCs$Dist[r] <- sqrt(((ord_imm_feature_PCs[r,1]-0)^2)+((ord_imm_feature_PCs[r,2]-0)^2))
}

#We also assess contributions of variables
ord_imm_contrib <- as.data.frame(ord_imm_res$center^2)
#We rename the rows
colnames(ord_imm_contrib) <- "Cont"

imm_feat_arrows_pre <- data.frame(
  xstart = rep(0,15),  # Replace with your actual x-coordinate start points
  ystart = rep(0,15),  # Replace with your actual y-coordinate start points
  xend = (200)*ord_imm_feature_PCs$PC1,  # Replace with your actual x-coordinate end points
  yend = (200)*ord_imm_feature_PCs$PC2,  # Replace with your actual y-coordinate end points
  label=rownames(ord_imm_feature_PCs)
)



imm_feat_arrows <- imm_feat_arrows_pre[which(imm_feat_arrows_pre$label %in% rownames(ord_imm_feature_PCs)[which(ord_imm_feature_PCs$Dist>0.11)]),]


imm_feat_arrows$DisplayLabel <- imm_feat_arrows$label
imm_feat_arrows$DisplayLabel <- gsub("CD14_","CD14+",imm_feat_arrows$DisplayLabel)
imm_feat_arrows$DisplayLabel <- gsub("CD4_","CD4+",imm_feat_arrows$DisplayLabel)
imm_feat_arrows$DisplayLabel <- gsub("CD8_","CD8+",imm_feat_arrows$DisplayLabel)
imm_feat_arrows$DisplayLabel <- gsub("CD3_","CD3+",imm_feat_arrows$DisplayLabel)
imm_feat_arrows$DisplayLabel <- gsub("neg","-",imm_feat_arrows$DisplayLabel)
imm_feat_arrows$DisplayLabel <- gsub("pos","+",imm_feat_arrows$DisplayLabel)
imm_feat_arrows$DisplayLabel <- gsub("_Percent","(%)",imm_feat_arrows$DisplayLabel)
imm_feat_arrows$DisplayLabel <- gsub("_PD1","PD-1+",imm_feat_arrows$DisplayLabel)
imm_feat_arrows$DisplayLabel <- gsub("Percent","(%)",imm_feat_arrows$DisplayLabel)
imm_feat_arrows$DisplayLabel <- gsub("_HLADR","HLADR+",imm_feat_arrows$DisplayLabel)
imm_feat_arrows$DisplayLabel <- gsub("_CD38","CD38",imm_feat_arrows$DisplayLabel)
imm_feat_arrows$DisplayLabel <- gsub("PD1","PD-1+",imm_feat_arrows$DisplayLabel)
imm_feat_arrows$DisplayLabel[which(substr(imm_feat_arrows$DisplayLabel,1,4)!="CD14")] <- paste0(imm_feat_arrows$DisplayLabel[which(substr(imm_feat_arrows$DisplayLabel,1,4)!="CD14")], " T Cells")
imm_feat_arrows$DisplayLabel <- gsub("CD14+IntermediatePD-1+(%)","CD14+PD-1+ Intermediate Monocytes",imm_feat_arrows$DisplayLabel)
imm_feat_arrows$DisplayLabel <- gsub("CD14+ClassicalPD-1+(%)" ,"CD14+PD-1+ CLassical Monocytes",imm_feat_arrows$DisplayLabel)

#Now the ordination data for the samples is pulled

ord_imm_data <- as.data.frame(ord_imm_res$x)

#The sample ID is pulled
ord_imm_data$SampleID <- base$SampleID

#We now add all the metadata for plotting
ord_imm_data_met <- inner_join(ord_imm_data, base, by="SampleID")

#We color by weeks so need to display 
ord_imm_data_met$DisplayWeek <- paste0(ord_imm_data_met$Week, " Weeks")

ord_imm_data_met$Cohort_Week <- paste0(ord_imm_data_met$Cohort," - ",ord_imm_data_met$DisplayWeek) 
  #We do it wide for the directionallity

ord_imm_data_met$Cohort_Week <- factor(ord_imm_data_met$Cohort_Week, levels=c("Naïve - 0 Weeks","Naïve - 24 Weeks","Exp - 0 Weeks","Exp - 24 Weeks","HC - 0 Weeks","HC - 24 Weeks"))




imm_pcoaplot_biplot <- ggplot(data = ord_imm_data_met, size=2, alpha=.5, aes(x = as.numeric(ord_imm_data_met$PC1), y = as.numeric(ord_imm_data_met$PC2))) + 
  geom_point(data=ord_imm_data_met,aes(fill=Cohort_Week, color = Cohort_Week),shape=21, size=3, stroke=1, alpha=0.5)+
  scale_color_identity()+
  geom_line(size=.5, alpha=.3, aes(group=ord_imm_data_met$PID))+
#             scale_color_manual(values=c("#A6611A","gray","#018571"), name="Cohort")+
                scale_fill_manual(values=c("#A6611A","#A6611A","gray","gray","#018571","#018571"), name="Cohort")+
                scale_color_manual(values=c("#A6611A","black","gray","black","#018571","black"), name="Cohort")+  
  labs(x="PC1", y="PC2", key=" ", title="PCoA of Flow Cytometry Data", tag="D")+
  geom_segment(data = imm_feat_arrows, aes(x = xstart, y = ystart, xend = xend, yend = yend),arrow = arrow(length = unit(0.3, "cm")), color="red", inherit.aes = FALSE)+
  geom_label_repel(data=imm_feat_arrows, aes(x = imm_feat_arrows$xend, y = imm_feat_arrows$yend, label=imm_feat_arrows$DisplayLabel), size=4, color="red", fill="white", inherit.aes = FALSE)+
  guides(color=guide_legend(nrow=1,bycol=TRUE))+
  theme_bw()+
  theme(title=element_text(size=15),
        axis.text.y=element_text(size=15),
        axis.text.x=element_text(size=15),
        strip.text.y = element_text(size=15),
        strip.text.x = element_text(size=15),
        axis.title = element_text(size=15),
        axis.title.y.right = element_text(size = 15),
        legend.text=element_text(size=15),
        plot.tag = element_text(size=25),
        legend.title=element_blank(),
        legend.position = "none")



imm_pcoaplot_strat <- ggplot(data = ord_imm_data_met, size=2, alpha=.5, aes(x = as.numeric(ord_imm_data_met$PC1), y = as.numeric(ord_imm_data_met$PC2))) + 
  geom_point(data=ord_imm_data_met,aes(fill=Cohort_Week, color = Cohort_Week),shape=21, size=3, stroke=1, alpha=0.5)+
  scale_color_identity()+
  geom_line(size=.5, alpha=.3, aes(group=ord_imm_data_met$PID))+
  stat_ellipse(geom="polygon",
               aes(fill=ord_imm_data_met$Cohort_Week, 
                   color = ord_imm_data_met$Cohort_Week,
                  color=ord_imm_data_met$Cohort_Week
                   ),
               alpha=0.25)+
               scale_fill_manual(values=c("#A6611A","#A6611A","gray","gray","#018571","#018571"), name="Cohort")+
                scale_color_manual(values=c("#A6611A","black","gray","black","#018571","black"), name="Cohort")+  
  labs(x="PC1", y="PC2", key=" ", title="PCoA of Flow Cytometry Data", tag="E")+
  guides(color=guide_legend(nrow=6,bycol=TRUE))+
  theme_bw()+
  theme(title=element_text(size=15),
        axis.text.y=element_text(size=15),
        axis.text.x=element_text(size=15),
        strip.text.y = element_text(size=15),
        strip.text.x = element_text(size=15),
        axis.title = element_text(size=15),
        axis.title.y.right = element_text(size = 15),
        legend.text=element_text(size=15),
        plot.tag = element_text(size=25),
        legend.title=element_blank(),
        legend.position = "right")+
  facet_nested(cols=vars(Cohort))


```


#### Linear Mixed Effects Models  - All Participants

```{r}


imm_pc_vars <- c("PC1","PC2","PC3","PC4")

#We generate an linear mixed effects model data set to inlcude results
imm_pc_lm_data <- unique(expand.grid(imm_pc_vars, met_vars))

colnames(imm_pc_lm_data) <- c("Predictor","Outcome")
#We generate fields for the statistics
imm_pc_lm_data["pval"] <- NA
imm_pc_lm_data["padj"] <- NA
imm_pc_lm_data["coef"] <- NA
imm_pc_lm_data["sig"] <- NA
imm_pc_lm_data["percent_variance_exp"] <- NA

for (response in met_vars) { 
  #We pull the confounders for that variable
  conf_r <- get(paste0("conf_vars_",response))
  
  #We add them to the imm_pc_vars
  imm_pc_vars_full <- c(imm_pc_vars,conf_r)
  
  #We remove missing variables
  data_r <- na.omit(ord_imm_data_met[,c(response,imm_pc_vars_full,"PID")])
  
  # create full model 
  ff <- as.formula(paste0(response,"~",paste0(imm_pc_vars_full, collapse="+"),"+(1|PID)")) 
  fm <- lmer(ff,
             data = data_r)
  
  predict_fm <- predict(fm)
  sum_fm <- summary(fm)
  
  #Below we calculate the R -suared value
  #First total sum of squares
    tss <- sum((unlist(data_r[,c(response)])-mean(unlist(data_r[,c(response)])))^2)
    #Second residual sum of squares
    rss <- sum((unlist(data_r[,c(response)])-predict_fm)^2)
  #R-squared
  r_squared <- 1-(rss/tss)
  #Percent variance explained
  pve <- r_squared*100
  
  imm_pc_lm_data$percent_variance_exp[which(imm_pc_lm_data$Outcome==response)] <- pve
  class(pve) <- "numeric"
  
  #We pull out the coefficinets
  coef_fm <- as.data.frame(sum_fm$coefficients)
  coef_fm$padj <- p.adjust(coef_fm$`Pr(>|t|)`, method="fdr")
  
  #Now we go through each predictor and pull out the coefficient in p-value 
  for (pred in imm_pc_vars) {
    #We pull the row in the coefficient data set (use substr because sometime strings are added)
    coef_row <- which(substr(rownames(coef_fm),1,nchar(pred))==pred)
    #We not pull the row from the lm data set to put it in
    stat_row <- which(as.character(imm_pc_lm_data$Predictor)==pred & as.character(imm_pc_lm_data$Outcome)==response)
    #We add an if statemenbt to make sure we only add values when its ad 
    
    if (length(coef_row)==1 & length(stat_row)==1) {
      #We pull out the p-valueand adjusted p-value
      imm_pc_lm_data$pval[stat_row] <- coef_fm$`Pr(>|t|)`[coef_row]
      imm_pc_lm_data$padj[stat_row] <- coef_fm$padj[coef_row]
      #We pull out the coefficient
      imm_pc_lm_data$coef[stat_row] <- coef_fm$Estimate[coef_row]
      
      #Based on the direction we indicate if it is positive of negative
      if (imm_pc_lm_data$coef[stat_row]>0) {
        imm_pc_lm_data$sig[stat_row] <- "Positive"
      } 
      if (imm_pc_lm_data$coef[stat_row]<0) {
        imm_pc_lm_data$sig[stat_row] <- "Negative"
      } 
      if (imm_pc_lm_data$padj[stat_row]<0.05) {
        imm_pc_lm_data$sig[stat_row] <- paste0(imm_pc_lm_data$sig[stat_row], " (Significant)")
      }
      
      
      
    }
  }
  
  
}


#We add -C to the LDL and HDL for visualization
imm_pc_lm_data$DisplayOutcome <- gsub("DL","DL-C",imm_pc_lm_data$Outcome)
#We replace the trig abbreviation with the full Triglycerides name 
imm_pc_lm_data$DisplayOutcome <- gsub("Trig","Triglycerides",imm_pc_lm_data$DisplayOutcome)
#Now we add the percent variance explained
imm_pc_lm_data$DisplayOutcome <- paste0(imm_pc_lm_data$DisplayOutcome, " (",round(imm_pc_lm_data$percent_variance_exp,1),"% exp)")


imm_pc_plot <- ggplot(imm_pc_lm_data, aes(x = Predictor, y = DisplayOutcome, color=sig)) +
  scale_color_manual(values=c("lightblue","pink","red"))+
  geom_point(size=5) +
  theme_minimal() +
  labs(x = "Plasma Measure", y = " ", fill=" ", tag="F", title="All Participants") +
  theme_classic() +
  guides(color = guide_legend(ncol = 1))+
  theme(legend.position = "right",
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        axis.text.y = element_text(size=12),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 12, angle=45, hjust=1),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        title = element_text(size=20),
        plot.tag = element_text(size=25))


```

#### Linear Mixed Effects Models  - Naive Participants
```{r}


ord_imm_data_met_naive <- ord_imm_data_met[which(ord_imm_data_met$Cohort=="Naïve"),]
#We generate an linear mixed effects model data set to inlcude results
imm_pc_lm_data_naive <- unique(expand.grid(imm_pc_vars, met_vars))

colnames(imm_pc_lm_data_naive) <- c("Predictor","Outcome")
#We generate fields for the statistics
imm_pc_lm_data_naive["pval"] <- NA
imm_pc_lm_data_naive["padj"] <- NA
imm_pc_lm_data_naive["coef"] <- NA
imm_pc_lm_data_naive["sig"] <- NA
imm_pc_lm_data_naive["percent_variance_exp"] <- NA

for (response in met_vars) { 
  #We pull the confounders for that variable
  conf_r <- get(paste0("conf_vars_",response))
  
  #We add them to the imm_pc_vars
  #Because they are all HIV positive (HIV should be removed if in there)
  
  imm_pc_vars_full <- setdiff(c(imm_pc_vars,conf_r),"HIV_Status")
  
  #We remove missing variables
  data_r <- na.omit(ord_imm_data_met_naive[,c(response,imm_pc_vars_full,"PID")])
  
  # create full model 
  ff <- as.formula(paste0(response,"~",paste0(imm_pc_vars_full, collapse="+"),"+(1|PID)")) 
  fm <- lmer(ff,
             data = data_r)
  
  predict_fm <- predict(fm)
  sum_fm <- summary(fm)
  
  #Below we calculate the R -suared value
  #First total sum of squares
    tss <- sum((unlist(data_r[,c(response)])-mean(unlist(data_r[,c(response)])))^2)
    #Second residual sum of squares
    rss <- sum((unlist(data_r[,c(response)])-predict_fm)^2)
  #R-squared
  r_squared <- 1-(rss/tss)
  #Percent variance explained
  pve <- r_squared*100
  
  imm_pc_lm_data_naive$percent_variance_exp[which(imm_pc_lm_data_naive$Outcome==response)] <- pve
  class(pve) <- "numeric"
  
  #We pull out the coefficinets
  coef_fm <- as.data.frame(sum_fm$coefficients)
  coef_fm$padj <- p.adjust(coef_fm$`Pr(>|t|)`, method="fdr")
  
  #Now we go through each predictor and pull out the coefficient in p-value 
  for (pred in imm_pc_vars) {
    #We pull the row in the coefficient data set (use substr because sometime strings are added)
    coef_row <- which(substr(rownames(coef_fm),1,nchar(pred))==pred)
    #We not pull the row from the lm data set to put it in
    stat_row <- which(as.character(imm_pc_lm_data_naive$Predictor)==pred & as.character(imm_pc_lm_data_naive$Outcome)==response)
    #We add an if statemenbt to make sure we only add values when its ad 
    
    if (length(coef_row)==1 & length(stat_row)==1) {
      #We pull out the p-valueand adjusted p-value
      imm_pc_lm_data_naive$pval[stat_row] <- coef_fm$`Pr(>|t|)`[coef_row]
      imm_pc_lm_data_naive$padj[stat_row] <- coef_fm$padj[coef_row]
      #We pull out the coefficient
      imm_pc_lm_data_naive$coef[stat_row] <- coef_fm$Estimate[coef_row]
      
      #Based on the direction we indicate if it is positive of negative
      if (imm_pc_lm_data_naive$coef[stat_row]>0) {
        imm_pc_lm_data_naive$sig[stat_row] <- "Positive"
      } 
      if (imm_pc_lm_data_naive$coef[stat_row]<0) {
        imm_pc_lm_data_naive$sig[stat_row] <- "Negative"
      } 
      if (imm_pc_lm_data_naive$padj[stat_row]<0.05) {
        imm_pc_lm_data_naive$sig[stat_row] <- paste0(imm_pc_lm_data_naive$sig[stat_row], " (Significant)")
      }
      
      
      
    }
  }
  
  
}


#We add -C to the LDL and HDL for visualization
imm_pc_lm_data_naive$DisplayOutcome <- gsub("DL","DL-C",imm_pc_lm_data_naive$Outcome)
#We replace the trig abbreviation with the full Triglycerides name 
imm_pc_lm_data_naive$DisplayOutcome <- gsub("Trig","Triglycerides",imm_pc_lm_data_naive$DisplayOutcome)
#Now we add the percent variance explained
imm_pc_lm_data_naive$DisplayOutcome <- paste0(imm_pc_lm_data_naive$DisplayOutcome, " (",round(imm_pc_lm_data_naive$percent_variance_exp,1),"% exp)")


imm_pc_plot_naive <- ggplot(imm_pc_lm_data_naive, aes(x = Predictor, y = DisplayOutcome, color=sig)) +
  scale_color_manual(values=c("lightblue","pink","red"))+
  geom_point(size=5) +
  theme_minimal() +
  labs(x = "Plasma Measure", y = " ", fill=" ", tag="F", title="Naïve Participants") +
  theme_classic() +
  guides(color = guide_legend(ncol = 1))+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        axis.text.y = element_text(size=12),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 12, angle=45, hjust=1),
        strip.text.x = element_text(size=15),
        strip.text.y = element_text(size=15),
        title = element_text(size=20),
        plot.tag = element_text(size=25))


```


####Plot Saving
```{r}


saveRDS(imm_select_viol, file = "../../Figures/Panels/FIG2A.RDS")
saveRDS(imm_plot, file = "../../Figures/Panels/FIG2B.RDS")
saveRDS(mono_med_dag, file = "../../Figures/Panels/FIG2C.RDS")
saveRDS(imm_pcoaplot_biplot, file = "../../Figures/Panels/FIG2D.RDS")
saveRDS(imm_pcoaplot_strat, file = "../../Figures/Panels/FIG2E.RDS")
saveRDS(imm_pc_plot_naive, file = "../../Figures/Panels/FIG2F.RDS")



```

